{
    "sourceFile": "pages/profile/edit.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1755747736733,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1755749379754,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,14 +2,9 @@\n import { useRouter } from \"next/router\";\n import { useAuthState } from \"react-firebase-hooks/auth\";\n import { auth, db, storage } from \"../../lib/firebase\";\n import { doc, getDoc, updateDoc } from \"firebase/firestore\";\n-import {\n-  updateEmail,\n-  updatePassword,\n-  reauthenticateWithCredential,\n-  EmailAuthProvider,\n-} from \"firebase/auth\";\n+import { updateEmail, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from \"firebase/auth\";\n import { ref, uploadBytes, getDownloadURL } from \"firebase/storage\";\n import Navbar from \"../../components/Navbar\";\n \n export default function EditProfile() {\n@@ -24,9 +19,9 @@\n   const [phone, setPhone] = useState(\"\");\n   const [email, setEmail] = useState(\"\");\n   const [newPassword, setNewPassword] = useState(\"\");\n   const [confirmPassword, setConfirmPassword] = useState(\"\");\n-  const [currentPassword, setCurrentPassword] = useState(\"\"); // Para reautenticar\n+  const [currentPassword, setCurrentPassword] = useState(\"\");\n \n   // Foto de perfil\n   const [photoURL, setPhotoURL] = useState(\"\");\n   const [file, setFile] = useState(null);\n@@ -68,9 +63,9 @@\n \n     loadUserData();\n   }, [user, loadingAuth, router]);\n \n-  // Manejar cambio de foto\n+  // Manejar cambio de archivo\n   const handleFileChange = (e) => {\n     if (e.target.files[0]) {\n       setFile(e.target.files[0]);\n     }\n@@ -80,35 +75,32 @@\n   const uploadPhoto = async () => {\n     if (!file) return photoURL;\n \n     setUploading(true);\n-    const storageRef = ref(storage, `profile-images/${user.uid}`);\n+    setError(\"\");\n     try {\n+      const storageRef = ref(storage, `profile-images/${user.uid}`);\n       await uploadBytes(storageRef, file);\n       const downloadURL = await getDownloadURL(storageRef);\n       setPhotoURL(downloadURL);\n       return downloadURL;\n     } catch (err) {\n       console.error(\"Error al subir foto:\", err);\n-      setError(\"No se pudo subir la foto.\");\n+      setError(\"No se pudo subir la foto: \" + (err.message || \"Error desconocido\"));\n       return photoURL;\n     } finally {\n       setUploading(false);\n     }\n   };\n \n-  // Reautenticar al usuario (necesario para cambiar email o contraseña)\n+  // Reautenticar (obligatorio para cambiar email/contraseña)\n   const reauthenticate = async () => {\n-    if (!currentPassword)\n-      throw new Error(\"Necesitas ingresar tu contraseña actual.\");\n-    const credential = EmailAuthProvider.credential(\n-      user.email,\n-      currentPassword\n-    );\n+    if (!currentPassword) throw new Error(\"Debes ingresar tu contraseña actual.\");\n+    const credential = EmailAuthProvider.credential(user.email, currentPassword);\n     await reauthenticateWithCredential(user, credential);\n   };\n \n-  // Guardar cambios\n+  // Manejar envío del formulario\n   const handleSubmit = async (e) => {\n     e.preventDefault();\n     setError(\"\");\n     setSuccess(\"\");\n@@ -118,12 +110,12 @@\n       if (email !== user.email || newPassword) {\n         await reauthenticate();\n       }\n \n-      // Subir foto si hay\n+      // Subir foto si hay archivo nuevo\n       const photoDownloadURL = await uploadPhoto();\n \n-      // Actualizar Firestore\n+      // Actualizar datos en Firestore\n       const userDocRef = doc(db, \"users\", user.uid);\n       await updateDoc(userDocRef, {\n         name,\n         phone,\n@@ -148,23 +140,23 @@\n \n       setSuccess(\"Perfil actualizado con éxito.\");\n     } catch (err) {\n       console.error(\"Error al actualizar perfil:\", err);\n-      if (err.message.includes(\"password\")) {\n+      if (err.message.includes(\"Contraseña actual incorrecta\")) {\n         setError(\"Contraseña actual incorrecta.\");\n       } else if (err.code === \"auth/requires-recent-login\") {\n-        setError(\n-          \"Por seguridad, debes volver a iniciar sesión para realizar este cambio.\"\n-        );\n+        setError(\"Por seguridad, debes volver a iniciar sesión para realizar este cambio.\");\n+      } else if (err.code === \"auth/email-already-in-use\") {\n+        setError(\"Este email ya está en uso.\");\n       } else {\n-        setError(err.message || \"No se pudo actualizar el perfil.\");\n+        setError(\"Error: \" + (err.message || \"No se pudo actualizar el perfil.\"));\n       }\n     }\n   };\n \n   if (loadingAuth || loading) {\n     return (\n-      <div className=\"flex items-center justify-center min-h-screen\">\n+      <div className=\"flex items-center justify-center min-h-screen bg-gray-50\">\n         <p>Cargando...</p>\n       </div>\n     );\n   }\n@@ -172,12 +164,16 @@\n   if (!user) return null;\n \n   return (\n     <div className=\"min-h-screen bg-gray-50\">\n+      {/* ✅ Navbar */}\n       <Navbar user={user} userData={userData} />\n+\n+      {/* Contenido principal */}\n       <div className=\"py-10 px-4 max-w-3xl mx-auto\">\n         <h1 className=\"text-2xl font-bold text-gray-800 mb-6\">Editar Perfil</h1>\n \n+        {/* Mensajes */}\n         {error && (\n           <div className=\"mb-4 p-3 bg-red-100 text-red-700 rounded\">\n             {error}\n           </div>\n@@ -187,26 +183,27 @@\n             {success}\n           </div>\n         )}\n \n-        <form\n-          onSubmit={handleSubmit}\n-          className=\"bg-white p-6 rounded-lg shadow\"\n-        >\n+        {/* Formulario */}\n+        <form onSubmit={handleSubmit} className=\"bg-white p-6 rounded-lg shadow\">\n           {/* Foto de perfil */}\n           <div className=\"mb-6\">\n             <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n               Foto de perfil\n             </label>\n-            {photoURL && (\n+\n+            {/* Vista previa de la foto actual o nueva */}\n+            {(photoURL || file) && (\n               <div className=\"mb-2\">\n                 <img\n-                  src={photoURL}\n-                  alt=\"Foto de perfil\"\n-                  className=\"w-20 h-20 rounded-full object-cover border\"\n+                  src={file ? URL.createObjectURL(file) : photoURL}\n+                  alt=\"Vista previa\"\n+                  className=\"w-20 h-20 rounded-full object-cover border-2 border-gray-200\"\n                 />\n               </div>\n             )}\n+\n             <input\n               type=\"file\"\n               accept=\"image/*\"\n               onChange={handleFileChange}\n@@ -217,10 +214,11 @@\n                 file:text-sm file:font-semibold\n                 file:bg-blue-50 file:text-blue-700\n                 hover:file:bg-blue-100\"\n             />\n+\n             {uploading && (\n-              <p className=\"text-sm text-blue-600 mt-1\">Subiendo...</p>\n+              <p className=\"text-sm text-blue-600 mt-1\">Subiendo imagen...</p>\n             )}\n           </div>\n \n           {/* Nombre */}\n@@ -232,9 +230,9 @@\n               type=\"text\"\n               value={name}\n               onChange={(e) => setName(e.target.value)}\n               required\n-              className=\"w-full p-3 border border-gray-300 rounded-lg\"\n+              className=\"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\n             />\n           </div>\n \n           {/* Teléfono */}\n@@ -246,9 +244,9 @@\n               type=\"tel\"\n               value={phone}\n               onChange={(e) => setPhone(e.target.value)}\n               placeholder=\"+54 11 1234 5678\"\n-              className=\"w-full p-3 border border-gray-300 rounded-lg\"\n+              className=\"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\n             />\n           </div>\n \n           {/* Email */}\n@@ -260,9 +258,9 @@\n               type=\"email\"\n               value={email}\n               onChange={(e) => setEmail(e.target.value)}\n               required\n-              className=\"w-full p-3 border border-gray-300 rounded-lg\"\n+              className=\"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\n             />\n           </div>\n \n           {/* Contraseña actual (para reautenticar) */}\n@@ -275,9 +273,9 @@\n               value={currentPassword}\n               onChange={(e) => setCurrentPassword(e.target.value)}\n               placeholder=\"Ingresa tu contraseña actual\"\n               required\n-              className=\"w-full p-3 border border-gray-300 rounded-lg\"\n+              className=\"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\n             />\n             <p className=\"text-xs text-gray-500 mt-1\">\n               Necesaria para cambiar email o contraseña.\n             </p>\n@@ -292,9 +290,9 @@\n               type=\"password\"\n               value={newPassword}\n               onChange={(e) => setNewPassword(e.target.value)}\n               placeholder=\"Dejar vacío si no quieres cambiarla\"\n-              className=\"w-full p-3 border border-gray-300 rounded-lg\"\n+              className=\"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\n             />\n           </div>\n \n           {/* Confirmar contraseña */}\n@@ -305,19 +303,21 @@\n             <input\n               type=\"password\"\n               value={confirmPassword}\n               onChange={(e) => setConfirmPassword(e.target.value)}\n-              className=\"w-full p-3 border border-gray-300 rounded-lg\"\n+              className=\"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\n             />\n           </div>\n \n+          {/* Botón */}\n           <button\n             type=\"submit\"\n-            className=\"w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg\"\n+            disabled={uploading}\n+            className=\"w-full py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white font-medium rounded-lg transition\"\n           >\n-            Guardar Cambios\n+            {uploading ? \"Guardando...\" : \"Guardar Cambios\"}\n           </button>\n         </form>\n       </div>\n     </div>\n   );\n-}\n+}\n\\ No newline at end of file\n"
                }
            ],
            "date": 1755747736733,
            "name": "Commit-0",
            "content": "import { useState, useEffect } from \"react\";\nimport { useRouter } from \"next/router\";\nimport { useAuthState } from \"react-firebase-hooks/auth\";\nimport { auth, db, storage } from \"../../lib/firebase\";\nimport { doc, getDoc, updateDoc } from \"firebase/firestore\";\nimport { updateEmail, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from \"firebase/auth\";\nimport { ref, uploadBytes, getDownloadURL } from \"firebase/storage\";\nimport Navbar from \"../../components/Navbar\";\n\nexport default function EditProfile() {\n  const [user, loadingAuth] = useAuthState(auth);\n  const [userData, setUserData] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(\"\");\n  const [success, setSuccess] = useState(\"\");\n\n  // Formulario\n  const [name, setName] = useState(\"\");\n  const [phone, setPhone] = useState(\"\");\n  const [email, setEmail] = useState(\"\");\n  const [newPassword, setNewPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [currentPassword, setCurrentPassword] = useState(\"\"); // Para reautenticar\n\n  // Foto de perfil\n  const [photoURL, setPhotoURL] = useState(\"\");\n  const [file, setFile] = useState(null);\n  const [uploading, setUploading] = useState(false);\n\n  const router = useRouter();\n\n  // Cargar datos del usuario\n  useEffect(() => {\n    if (loadingAuth) return;\n    if (!user) {\n      router.push(\"/login\");\n      return;\n    }\n\n    const loadUserData = async () => {\n      try {\n        const userDocRef = doc(db, \"users\", user.uid);\n        const userDocSnap = await getDoc(userDocRef);\n\n        if (!userDocSnap.exists()) {\n          setError(\"No se encontraron datos del usuario.\");\n          return;\n        }\n\n        const data = userDocSnap.data();\n        setUserData(data);\n        setName(data.name || \"\");\n        setPhone(data.phone || \"\");\n        setEmail(user.email || \"\");\n        setPhotoURL(data.photoURL || \"\");\n      } catch (err) {\n        console.error(\"Error al cargar perfil:\", err);\n        setError(\"No se pudo cargar el perfil.\");\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    loadUserData();\n  }, [user, loadingAuth, router]);\n\n  // Manejar cambio de foto\n  const handleFileChange = (e) => {\n    if (e.target.files[0]) {\n      setFile(e.target.files[0]);\n    }\n  };\n\n  // Subir foto a Firebase Storage\n  const uploadPhoto = async () => {\n    if (!file) return photoURL;\n\n    setUploading(true);\n    const storageRef = ref(storage, `profile-images/${user.uid}`);\n    try {\n      await uploadBytes(storageRef, file);\n      const downloadURL = await getDownloadURL(storageRef);\n      setPhotoURL(downloadURL);\n      return downloadURL;\n    } catch (err) {\n      console.error(\"Error al subir foto:\", err);\n      setError(\"No se pudo subir la foto.\");\n      return photoURL;\n    } finally {\n      setUploading(false);\n    }\n  };\n\n  // Reautenticar al usuario (necesario para cambiar email o contraseña)\n  const reauthenticate = async () => {\n    if (!currentPassword) throw new Error(\"Necesitas ingresar tu contraseña actual.\");\n    const credential = EmailAuthProvider.credential(user.email, currentPassword);\n    await reauthenticateWithCredential(user, credential);\n  };\n\n  // Guardar cambios\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setError(\"\");\n    setSuccess(\"\");\n\n    try {\n      // Reautenticar si se cambia email o contraseña\n      if (email !== user.email || newPassword) {\n        await reauthenticate();\n      }\n\n      // Subir foto si hay\n      const photoDownloadURL = await uploadPhoto();\n\n      // Actualizar Firestore\n      const userDocRef = doc(db, \"users\", user.uid);\n      await updateDoc(userDocRef, {\n        name,\n        phone,\n        photoURL: photoDownloadURL,\n      });\n\n      // Cambiar email si es diferente\n      if (email !== user.email) {\n        await updateEmail(user, email);\n      }\n\n      // Cambiar contraseña si se ingresó\n      if (newPassword) {\n        if (newPassword !== confirmPassword) {\n          throw new Error(\"Las contraseñas no coinciden.\");\n        }\n        if (newPassword.length < 6) {\n          throw new Error(\"La contraseña debe tener al menos 6 caracteres.\");\n        }\n        await updatePassword(user, newPassword);\n      }\n\n      setSuccess(\"Perfil actualizado con éxito.\");\n    } catch (err) {\n      console.error(\"Error al actualizar perfil:\", err);\n      if (err.message.includes(\"password\")) {\n        setError(\"Contraseña actual incorrecta.\");\n      } else if (err.code === \"auth/requires-recent-login\") {\n        setError(\"Por seguridad, debes volver a iniciar sesión para realizar este cambio.\");\n      } else {\n        setError(err.message || \"No se pudo actualizar el perfil.\");\n      }\n    }\n  };\n\n  if (loadingAuth || loading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <p>Cargando...</p>\n      </div>\n    );\n  }\n\n  if (!user) return null;\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <Navbar user={user} userData={userData} />\n      <div className=\"py-10 px-4 max-w-3xl mx-auto\">\n        <h1 className=\"text-2xl font-bold text-gray-800 mb-6\">Editar Perfil</h1>\n\n        {error && <div className=\"mb-4 p-3 bg-red-100 text-red-700 rounded\">{error}</div>}\n        {success && <div className=\"mb-4 p-3 bg-green-100 text-green-700 rounded\">{success}</div>}\n\n        <form onSubmit={handleSubmit} className=\"bg-white p-6 rounded-lg shadow\">\n          {/* Foto de perfil */}\n          <div className=\"mb-6\">\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Foto de perfil\n            </label>\n            {photoURL && (\n              <div className=\"mb-2\">\n                <img\n                  src={photoURL}\n                  alt=\"Foto de perfil\"\n                  className=\"w-20 h-20 rounded-full object-cover border\"\n                />\n              </div>\n            )}\n            <input\n              type=\"file\"\n              accept=\"image/*\"\n              onChange={handleFileChange}\n              disabled={uploading}\n              className=\"block w-full text-sm text-gray-500\n                file:mr-4 file:py-2 file:px-4\n                file:rounded-full file:border-0\n                file:text-sm file:font-semibold\n                file:bg-blue-50 file:text-blue-700\n                hover:file:bg-blue-100\"\n            />\n            {uploading && <p className=\"text-sm text-blue-600 mt-1\">Subiendo...</p>}\n          </div>\n\n          {/* Nombre */}\n          <div className=\"mb-4\">\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Nombre\n            </label>\n            <input\n              type=\"text\"\n              value={name}\n              onChange={(e) => setName(e.target.value)}\n              required\n              className=\"w-full p-3 border border-gray-300 rounded-lg\"\n            />\n          </div>\n\n          {/* Teléfono */}\n          <div className=\"mb-4\">\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Teléfono\n            </label>\n            <input\n              type=\"tel\"\n              value={phone}\n              onChange={(e) => setPhone(e.target.value)}\n              placeholder=\"+54 11 1234 5678\"\n              className=\"w-full p-3 border border-gray-300 rounded-lg\"\n            />\n          </div>\n\n          {/* Email */}\n          <div className=\"mb-4\">\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Email\n            </label>\n            <input\n              type=\"email\"\n              value={email}\n              onChange={(e) => setEmail(e.target.value)}\n              required\n              className=\"w-full p-3 border border-gray-300 rounded-lg\"\n            />\n          </div>\n\n          {/* Contraseña actual (para reautenticar) */}\n          <div className=\"mb-4\">\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Contraseña actual\n            </label>\n            <input\n              type=\"password\"\n              value={currentPassword}\n              onChange={(e) => setCurrentPassword(e.target.value)}\n              placeholder=\"Ingresa tu contraseña actual\"\n              required\n              className=\"w-full p-3 border border-gray-300 rounded-lg\"\n            />\n            <p className=\"text-xs text-gray-500 mt-1\">\n              Necesaria para cambiar email o contraseña.\n            </p>\n          </div>\n\n          {/* Nueva contraseña */}\n          <div className=\"mb-4\">\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Nueva contraseña (opcional)\n            </label>\n            <input\n              type=\"password\"\n              value={newPassword}\n              onChange={(e) => setNewPassword(e.target.value)}\n              placeholder=\"Dejar vacío si no quieres cambiarla\"\n              className=\"w-full p-3 border border-gray-300 rounded-lg\"\n            />\n          </div>\n\n          {/* Confirmar contraseña */}\n          <div className=\"mb-6\">\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Confirmar nueva contraseña\n            </label>\n            <input\n              type=\"password\"\n              value={confirmPassword}\n              onChange={(e) => setConfirmPassword(e.target.value)}\n              className=\"w-full p-3 border border-gray-300 rounded-lg\"\n            />\n          </div>\n\n          <button\n            type=\"submit\"\n            className=\"w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg\"\n          >\n            Guardar Cambios\n          </button>\n        </form>\n      </div>\n    </div>\n  );\n}"
        }
    ]
}