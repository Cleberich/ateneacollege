{
    "sourceFile": "pages/admin/dashboard.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1755745992452,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1755746012507,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -253,9 +253,9 @@\n               onChange={(e) => setSearchTerm(e.target.value)}\n               className=\"w-full p-3 border border-gray-300 rounded-lg mb-4\"\n             />\n           </div>\n-          <main>\n+          <main className=\"space-y-8 grid grid-cols-2\">\n             {/* Tabla de cursos */}\n             <div className=\"bg-white p-6 rounded-lg shadow mb-8 overflow-x-auto\">\n               <h2 className=\"text-xl font-semibold mb-4\">Todos los Cursos</h2>\n               <table className=\"min-w-full\">\n"
                },
                {
                    "date": 1755746039989,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -232,9 +232,9 @@\n   return (\n     <>\n       <Navbar user={user} userData={user} />\n       <div className=\"min-h-screen bg-gray-50 py-8\">\n-        <div className=\"max-w-7xl mx-auto px-4\">\n+        <div className=\"max-w-8xl mx-auto px-4\">\n           <h1 className=\"text-3xl font-bold text-gray-800 mb-6\">\n             Panel de Administrador\n           </h1>\n           <p className=\"text-gray-600 mb-8\">\n"
                }
            ],
            "date": 1755745992452,
            "name": "Commit-0",
            "content": "import { useState, useEffect } from \"react\";\nimport { useRouter } from \"next/router\";\nimport { useAuthState } from \"react-firebase-hooks/auth\";\nimport { auth, db } from \"../../lib/firebase\";\nimport {\n  collection,\n  getDocs,\n  query,\n  where,\n  addDoc,\n  getDoc,\n  doc,\n  updateDoc,\n} from \"firebase/firestore\";\nimport Navbar from \"../../components/Navbar\"; // Aseg√∫rate de que la ruta sea correcta\n\nexport default function AdminDashboard() {\n  const router = useRouter();\n  const [user, loadingAuth] = useAuthState(auth);\n  const [admin, setAdmin] = useState(null);\n  const [users, setUsers] = useState([]);\n  const [courses, setCourses] = useState([]);\n  const [enrollments, setEnrollments] = useState([]); // ‚Üê Lista de todas las inscripciones\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(\"\");\n\n  // Para asignar curso\n  const [selectedUserId, setSelectedUserId] = useState(\"\");\n  const [selectedCourseId, setSelectedCourseId] = useState(\"\");\n  const [assigning, setAssigning] = useState(false);\n\n  // Para editar curso\n  const [editingCourse, setEditingCourse] = useState(null);\n  const [editTitle, setEditTitle] = useState(\"\");\n  const [editDescription, setEditDescription] = useState(\"\");\n\n  // Para b√∫squeda\n  const [searchTerm, setSearchTerm] = useState(\"\");\n\n  // Cargar datos\n  useEffect(() => {\n    const load = async () => {\n      if (loadingAuth) return;\n\n      if (!user) {\n        router.push(\"/login\");\n        return;\n      }\n\n      try {\n        // Verificar que el usuario sea admin\n        const userDoc = await getDoc(doc(db, \"users\", user.uid));\n        if (!userDoc.exists() || userDoc.data().role !== \"admin\") {\n          setError(\"Acceso denegado: no eres administrador.\");\n          router.push(\"/dashboard\");\n          return;\n        }\n\n        setAdmin(userDoc.data());\n\n        // Cargar todos los usuarios\n        const usersSnapshot = await getDocs(collection(db, \"users\"));\n        const usersList = usersSnapshot.docs\n          .map((doc) => ({ id: doc.id, ...doc.data() }))\n          .filter((u) => u.role === \"student\" || u.role === \"teacher\");\n        setUsers(usersList);\n\n        // Cargar todos los cursos\n        const coursesSnapshot = await getDocs(collection(db, \"courses\"));\n        const coursesList = coursesSnapshot.docs.map((doc) => ({\n          id: doc.id,\n          ...doc.data(),\n        }));\n        setCourses(coursesList);\n\n        // Cargar todas las inscripciones\n        const enrollmentsSnapshot = await getDocs(\n          collection(db, \"enrollments\")\n        );\n        const enrollmentsList = enrollmentsSnapshot.docs.map((doc) => ({\n          id: doc.id,\n          userId: doc.data().userId,\n          courseId: doc.data().courseId,\n          progress: doc.data().progress || [],\n          enrolledAt: doc.data().enrolledAt,\n        }));\n        setEnrollments(enrollmentsList);\n      } catch (err) {\n        console.error(\"Error al cargar datos:\", err);\n        setError(\"No se pudieron cargar los datos.\");\n      } finally {\n        setLoading(false);\n      }\n    };\n    console.log(user);\n    load();\n  }, [user, loadingAuth, router]);\n\n  // --- Contar estudiantes por curso ---\n  const getStudentCount = (courseId) => {\n    return enrollments.filter((e) => e.courseId === courseId).length;\n  };\n\n  // --- Iniciar edici√≥n de curso ---\n  const startEditingCourse = (course) => {\n    setEditingCourse(course);\n    setEditTitle(course.title);\n    setEditDescription(course.description || \"\");\n  };\n\n  // --- Guardar edici√≥n ---\n  const saveCourseEdit = async () => {\n    if (!editTitle.trim()) {\n      alert(\"El t√≠tulo no puede estar vac√≠o\");\n      return;\n    }\n\n    try {\n      const courseDocRef = doc(db, \"courses\", editingCourse.id);\n      await updateDoc(courseDocRef, {\n        title: editTitle.trim(),\n        description: editDescription.trim(),\n      });\n\n      // Actualizar estado local\n      setCourses(\n        courses.map((c) =>\n          c.id === editingCourse.id\n            ? {\n                ...c,\n                title: editTitle.trim(),\n                description: editDescription.trim(),\n              }\n            : c\n        )\n      );\n\n      setEditingCourse(null);\n      setEditTitle(\"\");\n      setEditDescription(\"\");\n    } catch (err) {\n      console.error(\"Error al actualizar curso:\", err);\n      alert(\"No se pudo actualizar el curso.\");\n    }\n  };\n\n  // --- Cancelar edici√≥n ---\n  const cancelEdit = () => {\n    setEditingCourse(null);\n    setEditTitle(\"\");\n    setEditDescription(\"\");\n  };\n\n  // --- Asignar curso a estudiante ---\n  const handleAssignCourse = async (e) => {\n    e.preventDefault();\n    if (!selectedUserId || !selectedCourseId) return;\n\n    setAssigning(true);\n    setError(\"\");\n\n    try {\n      // Verificar si ya est√° inscrito\n      const alreadyEnrolled = enrollments.some(\n        (e) => e.userId === selectedUserId && e.courseId === selectedCourseId\n      );\n\n      if (alreadyEnrolled) {\n        setError(\"El estudiante ya est√° inscrito en este curso.\");\n        setAssigning(false);\n        return;\n      }\n\n      // Crear inscripci√≥n\n      await addDoc(collection(db, \"enrollments\"), {\n        userId: selectedUserId,\n        courseId: selectedCourseId,\n        enrolledAt: new Date(),\n        progress: [],\n      });\n\n      // Actualizar estado local\n      setEnrollments([\n        ...enrollments,\n        {\n          userId: selectedUserId,\n          courseId: selectedCourseId,\n          progress: [],\n        },\n      ]);\n\n      alert(\"Curso asignado con √©xito.\");\n      setSelectedUserId(\"\");\n      setSelectedCourseId(\"\");\n    } catch (err) {\n      console.error(\"Error al asignar curso:\", err);\n      setError(\"No se pudo asignar el curso.\");\n    } finally {\n      setAssigning(false);\n    }\n  };\n\n  // Filtrar cursos\n  const filteredCourses = courses.filter(\n    (c) =>\n      c.title.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      (c.teacherName || \"\").toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  if (loading || loadingAuth) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <p>Cargando panel de administrador...</p>\n      </div>\n    );\n  }\n\n  if (error && !loading) {\n    return (\n      <div className=\"p-6 text-center\">\n        <p className=\"text-red-600\">{error}</p>\n        <button\n          onClick={() => router.push(\"/dashboard\")}\n          className=\"mt-4 text-blue-600 hover:underline\"\n        >\n          ‚Üê Volver al dashboard\n        </button>\n      </div>\n    );\n  }\n\n  return (\n    <>\n      <Navbar user={user} userData={user} />\n      <div className=\"min-h-screen bg-gray-50 py-8\">\n        <div className=\"max-w-7xl mx-auto px-4\">\n          <h1 className=\"text-3xl font-bold text-gray-800 mb-6\">\n            Panel de Administrador\n          </h1>\n          <p className=\"text-gray-600 mb-8\">\n            Hola, {admin?.name || \"Admin\"} üëã\n          </p>\n\n          {/* Buscador de cursos */}\n          <div className=\"bg-white p-6 rounded-lg shadow mb-8\">\n            <h2 className=\"text-xl font-semibold mb-4\">\n              Buscar y Editar Cursos\n            </h2>\n            <input\n              type=\"text\"\n              placeholder=\"Buscar curso por t√≠tulo o profesor...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"w-full p-3 border border-gray-300 rounded-lg mb-4\"\n            />\n          </div>\n<main>\n          {/* Tabla de cursos */}\n          <div className=\"bg-white p-6 rounded-lg shadow mb-8 overflow-x-auto\">\n            <h2 className=\"text-xl font-semibold mb-4\">Todos los Cursos</h2>\n            <table className=\"min-w-full\">\n              <thead>\n                <tr className=\"border-b\">\n                  <th className=\"text-left py-2\">T√≠tulo</th>\n                  <th className=\"text-left py-2\">Profesor</th>\n                  <th className=\"text-left py-2\">Estudiantes</th>\n                  <th className=\"text-left py-2\">Lecciones</th>\n                  <th className=\"text-left py-2\">Acciones</th>\n                </tr>\n              </thead>\n              <tbody>\n                {filteredCourses.length > 0 ? (\n                  filteredCourses.map((c) => (\n                    <tr key={c.id} className=\"border-b\">\n                      <td className=\"py-3\">\n                        {editingCourse?.id === c.id ? (\n                          <input\n                            type=\"text\"\n                            value={editTitle}\n                            onChange={(e) => setEditTitle(e.target.value)}\n                            className=\"w-full p-1 border rounded\"\n                          />\n                        ) : (\n                          <span className=\"font-medium\">{c.title}</span>\n                        )}\n                      </td>\n                      <td className=\"py-3 text-sm text-gray-600\">\n                        {c.teacherName || \"Desconocido\"}\n                      </td>\n                      <td className=\"py-3\">{getStudentCount(c.id)}</td>\n                      <td className=\"py-3\">{c.lessons?.length || 0}</td>\n                      <td className=\"py-3\">\n                        {editingCourse?.id === c.id ? (\n                          <div className=\"flex gap-2\">\n                            <button\n                              onClick={saveCourseEdit}\n                              className=\"text-green-600 hover:underline text-sm\"\n                            >\n                              Guardar\n                            </button>\n                            <button\n                              onClick={cancelEdit}\n                              className=\"text-gray-600 hover:underline text-sm\"\n                            >\n                              Cancelar\n                            </button>\n                          </div>\n                        ) : (\n                          <button\n                            onClick={() => startEditingCourse(c)}\n                            className=\"text-indigo-600 hover:underline text-sm\"\n                          >\n                            ‚úèÔ∏è Editar\n                          </button>\n                        )}\n                      </td>\n                    </tr>\n                  ))\n                ) : (\n                  <tr>\n                    <td colSpan=\"5\" className=\"py-4 text-center text-gray-500\">\n                      No se encontraron cursos.\n                    </td>\n                  </tr>\n                )}\n              </tbody>\n            </table>\n          </div>\n\n          {/* Formulario: Asignar curso */}\n          <div className=\"bg-white p-6 rounded-lg shadow mb-8\">\n            <h2 className=\"text-xl font-semibold mb-4\">\n              Asignar Curso a Estudiante\n            </h2>\n            {error && (\n              <div className=\"mb-4 p-3 bg-red-100 text-red-700 rounded\">\n                {error}\n              </div>\n            )}\n\n            <form onSubmit={handleAssignCourse} className=\"space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                  Estudiante\n                </label>\n                <select\n                  value={selectedUserId}\n                  onChange={(e) => setSelectedUserId(e.target.value)}\n                  required\n                  className=\"w-full p-3 border border-gray-300 rounded-lg\"\n                >\n                  <option value=\"\">Seleccionar estudiante</option>\n                  {users\n                    .filter((u) => u.role === \"student\")\n                    .map((u) => (\n                      <option key={u.id} value={u.id}>\n                        {u.name} ({u.email})\n                      </option>\n                    ))}\n                </select>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                  Curso\n                </label>\n                <select\n                  value={selectedCourseId}\n                  onChange={(e) => setSelectedCourseId(e.target.value)}\n                  required\n                  className=\"w-full p-3 border border-gray-300 rounded-lg\"\n                >\n                  <option value=\"\">Seleccionar curso</option>\n                  {courses.map((c) => (\n                    <option key={c.id} value={c.id}>\n                      {c.title}\n                    </option>\n                  ))}\n                </select>\n              </div>\n\n              <button\n                type=\"submit\"\n                disabled={assigning}\n                className=\"px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white font-medium rounded-lg\"\n              >\n                {assigning ? \"Asignando...\" : \"Asignar Curso\"}\n              </button>\n            </form>\n          </div>\n\n          {/* Lista de Estudiantes */}\n          <div className=\"bg-white p-6 rounded-lg shadow mb-8\">\n            <h2 className=\"text-xl font-semibold mb-4\">Estudiantes</h2>\n            {users.filter((u) => u.role === \"student\").length > 0 ? (\n              <div className=\"overflow-x-auto\">\n                <table className=\"min-w-full\">\n                  <thead>\n                    <tr className=\"border-b\">\n                      <th className=\"text-left py-2\">Nombre</th>\n                      <th className=\"text-left py-2\">Email</th>\n                      <th className=\"text-left py-2\">Cursos Asignados</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {users\n                      .filter((u) => u.role === \"student\")\n                      .map((u) => (\n                        <StudentRow\n                          key={u.id}\n                          user={u}\n                          courses={courses}\n                          enrollments={enrollments}\n                        />\n                      ))}\n                  </tbody>\n                </table>\n              </div>\n            ) : (\n              <p>No hay estudiantes registrados.</p>\n            )}\n          </div>\n\n          {/* Lista de Profesores */}\n          <div className=\"bg-white p-6 rounded-lg shadow\">\n            <h2 className=\"text-xl font-semibold mb-4\">Profesores</h2>\n            {users.filter((u) => u.role === \"teacher\").length > 0 ? (\n              <ul className=\"space-y-2\">\n                {users\n                  .filter((u) => u.role === \"teacher\")\n                  .map((u) => (\n                    <li\n                      key={u.id}\n                      className=\"p-3 border border-gray-200 rounded\"\n                    >\n                      <strong>{u.name}</strong> ({u.email})\n                    </li>\n                  ))}\n              </ul>\n            ) : (\n              <p>No hay profesores registrados.</p>\n            )}\n          </div></main>\n        </div>\n      </div>{\" \"}\n    </>\n  );\n}\n\n// Componente para mostrar cursos asignados\nfunction StudentRow({ user, courses, enrollments }) {\n  const [assignedCourses, setAssignedCourses] = useState([]);\n\n  useEffect(() => {\n    const userEnrollments = enrollments.filter((e) => e.userId === user.id);\n    const coursesData = userEnrollments.map((e) => {\n      const course = courses.find((c) => c.id === e.courseId);\n      return {\n        title: course?.title || \"Curso eliminado\",\n        progress: e.progress?.length || 0,\n        total: course?.lessons?.length || 0,\n      };\n    });\n    setAssignedCourses(coursesData);\n  }, [user.id, courses, enrollments]);\n\n  return (\n    <tr>\n      <td className=\"py-3\">{user.name}</td>\n      <td className=\"py-3 text-sm text-gray-600\">{user.email}</td>\n      <td className=\"py-3\">\n        {assignedCourses.length > 0 ? (\n          <ul className=\"space-y-1\">\n            {assignedCourses.map((c, idx) => (\n              <li key={idx} className=\"text-sm\">\n                {c.title} ‚Äî {c.progress}/{c.total} lecciones\n              </li>\n            ))}\n          </ul>\n        ) : (\n          <span className=\"text-gray-500\">Ninguno</span>\n        )}\n      </td>\n    </tr>\n  );\n}\n"
        }
    ]
}