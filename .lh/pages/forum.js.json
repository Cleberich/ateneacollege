{
    "sourceFile": "pages/forum.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 28,
            "patches": [
                {
                    "date": 1755795579280,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1755795632079,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,8 +7,9 @@\n   collection,\n   query,\n   where,\n   getDocs,\n+  getDoc,\n   addDoc,\n   updateDoc,\n   doc,\n   serverTimestamp,\n"
                },
                {
                    "date": 1755795741756,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -239,9 +239,9 @@\n                 <div key={post.id} className=\"bg-white p-6 rounded-lg shadow\">\n                   {/* Cabecera */}\n                   <div className=\"flex items-center gap-3 mb-4\">\n                     <img\n-                      src={post.userPhoto || \"/img/user-placeholder.jpg\"}\n+                      src={post.photoURL || \"/img/user-placeholder.jpg\"}\n                       alt={post.userName}\n                       className=\"w-10 h-10 rounded-full object-cover border\"\n                     />\n                     <div>\n"
                },
                {
                    "date": 1755796035951,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,9 +7,8 @@\n   collection,\n   query,\n   where,\n   getDocs,\n-  getDoc,\n   addDoc,\n   updateDoc,\n   doc,\n   serverTimestamp,\n@@ -41,15 +40,21 @@\n       return;\n     }\n \n     const loadUserData = async () => {\n-      const userDoc = await getDoc(doc(db, \"users\", user.uid));\n-      if (!userDoc.exists()) {\n-        router.push(\"/register\");\n-        return;\n+      try {\n+        const userDoc = await getDoc(doc(db, \"users\", user.uid));\n+        if (!userDoc.exists()) {\n+          router.push(\"/register\");\n+          return;\n+        }\n+        setUserData(userDoc.data());\n+      } catch (err) {\n+        console.error(\"Error al cargar usuario:\", err);\n+        setError(\"No se pudo cargar tu perfil.\");\n+      } finally {\n+        setLoading(false);\n       }\n-      setUserData(userDoc.data());\n-      setLoading(false);\n     };\n \n     loadUserData();\n   }, [user, loadingAuth, router]);\n@@ -93,15 +98,18 @@\n     e.preventDefault();\n     if (!newPost.trim()) return;\n \n     try {\n+      // Priorizar foto del perfil, luego auth, luego null\n+      const userPhotoURL = userData?.photoURL || user?.photoURL || null;\n+\n       await addDoc(collection(db, \"forums\"), {\n         content: newPost.trim(),\n         imageUrl: image || null,\n         userId: user.uid,\n-        userName: userData.name,\n-        userPhoto: user.photoURL || null,\n-        userRole: userData.role,\n+        userName: userData?.name || \"Usuario\",\n+        userPhoto: userPhotoURL,\n+        userRole: userData?.role || \"student\",\n         likes: [],\n         commentsCount: 0,\n         createdAt: serverTimestamp(),\n       });\n@@ -120,33 +128,40 @@\n \n     const postRef = doc(db, \"forums\", post.id);\n     const hasLiked = post.likes.includes(user.uid);\n \n-    await updateDoc(postRef, {\n-      likes: hasLiked\n-        ? post.likes.filter((id) => id !== user.uid)\n-        : [...post.likes, user.uid],\n-    });\n+    try {\n+      await updateDoc(postRef, {\n+        likes: hasLiked\n+          ? post.likes.filter((id) => id !== user.uid)\n+          : [...post.likes, user.uid],\n+      });\n+    } catch (err) {\n+      console.error(\"Error al dar like:\", err);\n+      setError(\"No se pudo actualizar el like.\");\n+    }\n   };\n \n   // Agregar comentario\n   const handleAddComment = async (postId) => {\n     const content = newComment[postId]?.trim();\n     if (!content) return;\n \n     try {\n+      const userPhotoURL = userData?.photoURL || user?.photoURL || null;\n+\n       await addDoc(collection(db, \"comments\"), {\n         postId,\n         userId: user.uid,\n-        userName: userData.name,\n-        userPhoto: user.photoURL || null,\n+        userName: userData?.name || \"Usuario\",\n+        userPhoto: userPhotoURL,\n         content,\n         createdAt: serverTimestamp(),\n       });\n \n       setNewComment({ ...newComment, [postId]: \"\" });\n \n-      // Actualizar contador\n+      // Actualizar contador de comentarios\n       const postRef = doc(db, \"forums\", postId);\n       const postDoc = await getDoc(postRef);\n       if (postDoc.exists()) {\n         await updateDoc(postRef, {\n@@ -177,8 +192,12 @@\n       </div>\n     );\n   }\n \n+  if (!user) {\n+    return null;\n+  }\n+\n   return (\n     <>\n       <Navbar user={user} userData={userData} />\n       <div className=\"min-h-screen bg-gray-50 py-8\">\n@@ -189,8 +208,15 @@\n           <p className=\"text-gray-600 mb-6\">\n             Comparte ideas, dudas y conocimientos con la comunidad.\n           </p>\n \n+          {/* Mostrar error */}\n+          {error && (\n+            <div className=\"mb-4 p-3 bg-red-100 text-red-700 rounded\">\n+              {error}\n+            </div>\n+          )}\n+\n           {/* Crear publicaci√≥n */}\n           <form\n             onSubmit={handleCreatePost}\n             className=\"bg-white p-6 rounded-lg shadow mb-6\"\n@@ -225,10 +251,8 @@\n               Publicar\n             </button>\n           </form>\n \n-          {error && <p className=\"text-red-600 mb-4\">{error}</p>}\n-\n           {/* Lista de publicaciones */}\n           <div className=\"space-y-6\">\n             {posts.length === 0 ? (\n               <p className=\"text-gray-500 text-center py-8\">\n@@ -239,18 +263,32 @@\n                 <div key={post.id} className=\"bg-white p-6 rounded-lg shadow\">\n                   {/* Cabecera */}\n                   <div className=\"flex items-center gap-3 mb-4\">\n                     <img\n-                      src={post.photoURL || \"/img/user-placeholder.jpg\"}\n+                      src={post.userPhoto || \"/img/user-placeholder.jpg\"}\n                       alt={post.userName}\n                       className=\"w-10 h-10 rounded-full object-cover border\"\n+                      onError={(e) => {\n+                        e.target.src = \"/img/user-placeholder.jpg\";\n+                      }}\n                     />\n                     <div>\n                       <p className=\"font-medium text-gray-800\">\n                         {post.userName}\n                       </p>\n                       <p className=\"text-xs text-gray-500\">\n-                        {formatTimeAgo(post.createdAt)} ¬∑ {post.userRole}\n+                        {formatTimeAgo(post.createdAt)} ¬∑{\" \"}\n+                        <span\n+                          className={`${\n+                            post.userRole === \"teacher\"\n+                              ? \"text-indigo-600 bg-indigo-100\"\n+                              : \"text-green-600 bg-green-100\"\n+                          } px-1.5 py-0.5 rounded text-xs`}\n+                        >\n+                          {post.userRole === \"teacher\"\n+                            ? \"Profesor\"\n+                            : \"Estudiante\"}\n+                        </span>\n                       </p>\n                     </div>\n                   </div>\n \n@@ -265,23 +303,26 @@\n                       <img\n                         src={post.imageUrl}\n                         alt=\"Publicaci√≥n\"\n                         className=\"w-full max-h-80 object-cover rounded-lg\"\n+                        onError={(e) => {\n+                          e.target.src = \"/img/course-placeholder.jpg\";\n+                        }}\n                       />\n                     </div>\n                   )}\n \n                   {/* Acciones */}\n-                  <div className=\"flex items-center gap-6 text-sm\">\n+                  <div className=\"flex items-center gap-6 text-sm border-t pt-3\">\n                     <button\n                       onClick={() => handleLike(post)}\n                       className={`flex items-center gap-1 ${\n                         post.likes.includes(user?.uid)\n                           ? \"text-red-600\"\n                           : \"text-gray-500 hover:text-red-600\"\n                       }`}\n                     >\n-                      ‚ù§Ô∏è {post.likes.length}\n+                      ‚ù§Ô∏è {post.likes.length > 0 ? post.likes.length : \"\"}\n                     </button>\n                     <button\n                       onClick={() =>\n                         setShowComments((prev) => ({\n@@ -290,9 +331,9 @@\n                         }))\n                       }\n                       className=\"text-gray-500 hover:text-blue-600 flex items-center gap-1\"\n                     >\n-                      üí¨ {post.commentsCount}\n+                      üí¨ {post.commentsCount > 0 ? post.commentsCount : \"\"}\n                     </button>\n                   </div>\n \n                   {/* Comentarios */}\n@@ -313,8 +354,11 @@\n                                   \"/img/user-placeholder.jpg\"\n                                 }\n                                 alt={comment.userName}\n                                 className=\"w-8 h-8 rounded-full object-cover border\"\n+                                onError={(e) => {\n+                                  e.target.src = \"/img/user-placeholder.jpg\";\n+                                }}\n                               />\n                               <div>\n                                 <p className=\"text-sm font-medium text-gray-800\">\n                                   {comment.userName}\n"
                },
                {
                    "date": 1755796152591,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,8 +7,9 @@\n   collection,\n   query,\n   where,\n   getDocs,\n+  getDoc,\n   addDoc,\n   updateDoc,\n   doc,\n   serverTimestamp,\n"
                },
                {
                    "date": 1755796243413,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,12 +7,12 @@\n   collection,\n   query,\n   where,\n   getDocs,\n-  getDoc,\n   addDoc,\n   updateDoc,\n   doc,\n+  deleteDoc,\n   serverTimestamp,\n   orderBy,\n   onSnapshot,\n } from \"firebase/firestore\";\n@@ -23,9 +23,8 @@\n   const [userData, setUserData] = useState(null);\n   const [posts, setPosts] = useState([]);\n   const [newPost, setNewPost] = useState(\"\");\n   const [image, setImage] = useState(\"\");\n-  const [uploading, setUploading] = useState(false);\n   const [error, setError] = useState(\"\");\n   const [loading, setLoading] = useState(true);\n   const [comments, setComments] = useState({});\n   const [newComment, setNewComment] = useState({});\n@@ -99,9 +98,8 @@\n     e.preventDefault();\n     if (!newPost.trim()) return;\n \n     try {\n-      // Priorizar foto del perfil, luego auth, luego null\n       const userPhotoURL = userData?.photoURL || user?.photoURL || null;\n \n       await addDoc(collection(db, \"forums\"), {\n         content: newPost.trim(),\n@@ -160,9 +158,9 @@\n       });\n \n       setNewComment({ ...newComment, [postId]: \"\" });\n \n-      // Actualizar contador de comentarios\n+      // Actualizar contador\n       const postRef = doc(db, \"forums\", postId);\n       const postDoc = await getDoc(postRef);\n       if (postDoc.exists()) {\n         await updateDoc(postRef, {\n@@ -173,8 +171,70 @@\n       console.error(\"Error al comentar:\", err);\n     }\n   };\n \n+  // Eliminar publicaci√≥n\n+  const handleDeletePost = async (postId) => {\n+    if (\n+      !window.confirm(\"¬øEst√°s seguro de que quieres eliminar esta publicaci√≥n?\")\n+    )\n+      return;\n+\n+    try {\n+      const postRef = doc(db, \"forums\", postId);\n+      await deleteDoc(postRef);\n+\n+      // Eliminar comentarios asociados\n+      const commentsSnapshot = await getDocs(\n+        query(collection(db, \"comments\"), where(\"postId\", \"==\", postId))\n+      );\n+      commentsSnapshot.forEach(async (commentDoc) => {\n+        await deleteDoc(doc(db, \"comments\", commentDoc.id));\n+      });\n+\n+      // Actualizar estado local\n+      setPosts(posts.filter((p) => p.id !== postId));\n+      setComments((prev) => {\n+        const updated = { ...prev };\n+        delete updated[postId];\n+        return updated;\n+      });\n+    } catch (err) {\n+      console.error(\"Error al eliminar publicaci√≥n:\", err);\n+      setError(\"No se pudo eliminar la publicaci√≥n.\");\n+    }\n+  };\n+\n+  // Eliminar comentario\n+  const handleDeleteComment = async (postId, commentId) => {\n+    if (\n+      !window.confirm(\"¬øEst√°s seguro de que quieres eliminar este comentario?\")\n+    )\n+      return;\n+\n+    try {\n+      await deleteDoc(doc(db, \"comments\", commentId));\n+\n+      // Actualizar estado local\n+      setComments((prev) => ({\n+        ...prev,\n+        [postId]: prev[postId]?.filter((c) => c.id !== commentId),\n+      }));\n+\n+      // Reducir contador\n+      const postRef = doc(db, \"forums\", postId);\n+      const postDoc = await getDoc(postRef);\n+      if (postDoc.exists() && postDoc.data().commentsCount > 0) {\n+        await updateDoc(postRef, {\n+          commentsCount: postDoc.data().commentsCount - 1,\n+        });\n+      }\n+    } catch (err) {\n+      console.error(\"Error al eliminar comentario:\", err);\n+      setError(\"No se pudo eliminar el comentario.\");\n+    }\n+  };\n+\n   // Formatear fecha\n   const formatTimeAgo = (timestamp) => {\n     if (!timestamp) return \"ahora\";\n     const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);\n@@ -209,9 +269,8 @@\n           <p className=\"text-gray-600 mb-6\">\n             Comparte ideas, dudas y conocimientos con la comunidad.\n           </p>\n \n-          {/* Mostrar error */}\n           {error && (\n             <div className=\"mb-4 p-3 bg-red-100 text-red-700 rounded\">\n               {error}\n             </div>\n@@ -262,36 +321,49 @@\n             ) : (\n               posts.map((post) => (\n                 <div key={post.id} className=\"bg-white p-6 rounded-lg shadow\">\n                   {/* Cabecera */}\n-                  <div className=\"flex items-center gap-3 mb-4\">\n-                    <img\n-                      src={post.userPhoto || \"/img/user-placeholder.jpg\"}\n-                      alt={post.userName}\n-                      className=\"w-10 h-10 rounded-full object-cover border\"\n-                      onError={(e) => {\n-                        e.target.src = \"/img/user-placeholder.jpg\";\n-                      }}\n-                    />\n-                    <div>\n-                      <p className=\"font-medium text-gray-800\">\n-                        {post.userName}\n-                      </p>\n-                      <p className=\"text-xs text-gray-500\">\n-                        {formatTimeAgo(post.createdAt)} ¬∑{\" \"}\n-                        <span\n-                          className={`${\n-                            post.userRole === \"teacher\"\n-                              ? \"text-indigo-600 bg-indigo-100\"\n-                              : \"text-green-600 bg-green-100\"\n-                          } px-1.5 py-0.5 rounded text-xs`}\n-                        >\n-                          {post.userRole === \"teacher\"\n-                            ? \"Profesor\"\n-                            : \"Estudiante\"}\n-                        </span>\n-                      </p>\n+                  <div className=\"flex items-center justify-between mb-4\">\n+                    <div className=\"flex items-center gap-3\">\n+                      <img\n+                        src={post.userPhoto || \"/img/user-placeholder.jpg\"}\n+                        alt={post.userName}\n+                        className=\"w-10 h-10 rounded-full object-cover border\"\n+                        onError={(e) => {\n+                          e.target.src = \"/img/user-placeholder.jpg\";\n+                        }}\n+                      />\n+                      <div>\n+                        <p className=\"font-medium text-gray-800\">\n+                          {post.userName}\n+                        </p>\n+                        <p className=\"text-xs text-gray-500\">\n+                          {formatTimeAgo(post.createdAt)} ¬∑{\" \"}\n+                          <span\n+                            className={`${\n+                              post.userRole === \"teacher\"\n+                                ? \"text-indigo-600 bg-indigo-100\"\n+                                : \"text-green-600 bg-green-100\"\n+                            } px-1.5 py-0.5 rounded text-xs`}\n+                          >\n+                            {post.userRole === \"teacher\"\n+                              ? \"Profesor\"\n+                              : \"Estudiante\"}\n+                          </span>\n+                        </p>\n+                      </div>\n                     </div>\n+\n+                    {/* Bot√≥n de eliminar (solo si es el autor) */}\n+                    {post.userId === user.uid && (\n+                      <button\n+                        onClick={() => handleDeletePost(post.id)}\n+                        className=\"text-red-500 hover:text-red-700 text-lg\"\n+                        title=\"Eliminar publicaci√≥n\"\n+                      >\n+                        üóëÔ∏è\n+                      </button>\n+                    )}\n                   </div>\n \n                   {/* Contenido */}\n                   <p className=\"text-gray-700 mb-4 whitespace-pre-wrap\">\n@@ -343,13 +415,15 @@\n                       <h4 className=\"font-medium text-gray-800 mb-3\">\n                         Comentarios\n                       </h4>\n \n-                      {/* Lista de comentarios */}\n                       {comments[post.id]?.length > 0 ? (\n                         <ul className=\"space-y-3 mb-4\">\n                           {comments[post.id].map((comment) => (\n-                            <li key={comment.id} className=\"flex gap-3\">\n+                            <li\n+                              key={comment.id}\n+                              className=\"flex gap-3 bg-gray-50 p-3 rounded-lg\"\n+                            >\n                               <img\n                                 src={\n                                   comment.userPhoto ||\n                                   \"/img/user-placeholder.jpg\"\n@@ -359,12 +433,25 @@\n                                 onError={(e) => {\n                                   e.target.src = \"/img/user-placeholder.jpg\";\n                                 }}\n                               />\n-                              <div>\n-                                <p className=\"text-sm font-medium text-gray-800\">\n-                                  {comment.userName}\n-                                </p>\n+                              <div className=\"flex-1\">\n+                                <div className=\"flex items-center justify-between\">\n+                                  <p className=\"text-sm font-medium text-gray-800\">\n+                                    {comment.userName}\n+                                  </p>\n+                                  {comment.userId === user.uid && (\n+                                    <button\n+                                      onClick={() =>\n+                                        handleDeleteComment(post.id, comment.id)\n+                                      }\n+                                      className=\"text-red-500 hover:text-red-700 text-xs\"\n+                                      title=\"Eliminar comentario\"\n+                                    >\n+                                      üóëÔ∏è\n+                                    </button>\n+                                  )}\n+                                </div>\n                                 <p className=\"text-sm text-gray-600\">\n                                   {comment.content}\n                                 </p>\n                                 <p className=\"text-xs text-gray-400\">\n"
                },
                {
                    "date": 1755796264482,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,8 +8,9 @@\n   query,\n   where,\n   getDocs,\n   addDoc,\n+  getDoc,\n   updateDoc,\n   doc,\n   deleteDoc,\n   serverTimestamp,\n"
                },
                {
                    "date": 1755797340297,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -340,14 +340,18 @@\n                         <p className=\"text-xs text-gray-500\">\n                           {formatTimeAgo(post.createdAt)} ¬∑{\" \"}\n                           <span\n                             className={`${\n-                              post.userRole === \"teacher\"\n+                              post.userRole === \"admin\"\n+                                ? \"text-purple-600 bg-purple-100\"\n+                                : post.userRole === \"teacher\"\n                                 ? \"text-indigo-600 bg-indigo-100\"\n                                 : \"text-green-600 bg-green-100\"\n-                            } px-1.5 py-0.5 rounded text-xs`}\n+                            } px-1.5 py-0.5 rounded text-xs font-medium`}\n                           >\n-                            {post.userRole === \"teacher\"\n+                            {post.userRole === \"admin\"\n+                              ? \"Administrador\"\n+                              : post.userRole === \"teacher\"\n                               ? \"Profesor\"\n                               : \"Estudiante\"}\n                           </span>\n                         </p>\n"
                },
                {
                    "date": 1755797349683,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -348,9 +348,9 @@\n                                 : \"text-green-600 bg-green-100\"\n                             } px-1.5 py-0.5 rounded text-xs font-medium`}\n                           >\n                             {post.userRole === \"admin\"\n-                              ? \"Administrador\"\n+                              ? \"Direcci√≥n\"\n                               : post.userRole === \"teacher\"\n                               ? \"Profesor\"\n                               : \"Estudiante\"}\n                           </span>\n"
                },
                {
                    "date": 1755803967446,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,26 +73,43 @@\n \n     return () => unsubscribe();\n   }, []);\n \n-  // Escuchar comentarios\n+  // Escuchar comentarios (CORREGIDO)\n   useEffect(() => {\n-    const unsubscribeAll = posts.map((post) => {\n+    const unsubs = [];\n+\n+    posts.forEach((post) => {\n       const q = query(\n         collection(db, \"comments\"),\n         where(\"postId\", \"==\", post.id),\n         orderBy(\"createdAt\", \"asc\")\n       );\n-      return onSnapshot(q, (snapshot) => {\n-        const commentList = snapshot.docs.map((doc) => ({\n-          id: doc.id,\n-          ...doc.data(),\n-        }));\n-        setComments((prev) => ({ ...prev, [post.id]: commentList }));\n-      });\n+\n+      const unsub = onSnapshot(\n+        q,\n+        (snapshot) => {\n+          const commentList = snapshot.docs.map((doc) => ({\n+            id: doc.id,\n+            ...doc.data(),\n+          }));\n+          setComments((prev) => ({ ...prev, [post.id]: commentList }));\n+        },\n+        (error) => {\n+          console.error(\n+            \"Error al escuchar comentarios del post:\",\n+            post.id,\n+            error\n+          );\n+        }\n+      );\n+\n+      unsubs.push(unsub);\n     });\n \n-    return () => unsubscribeAll.forEach((unsub) => unsub && unsub());\n+    return () => {\n+      unsubs.forEach((unsub) => unsub());\n+    };\n   }, [posts]);\n \n   // Crear publicaci√≥n\n   const handleCreatePost = async (e) => {\n@@ -164,9 +181,9 @@\n       const postRef = doc(db, \"forums\", postId);\n       const postDoc = await getDoc(postRef);\n       if (postDoc.exists()) {\n         await updateDoc(postRef, {\n-          commentsCount: postDoc.data().commentsCount + 1,\n+          commentsCount: (postDoc.data().commentsCount || 0) + 1,\n         });\n       }\n     } catch (err) {\n       console.error(\"Error al comentar:\", err);\n@@ -223,11 +240,11 @@\n \n       // Reducir contador\n       const postRef = doc(db, \"forums\", postId);\n       const postDoc = await getDoc(postRef);\n-      if (postDoc.exists() && postDoc.data().commentsCount > 0) {\n+      if (postDoc.exists() && (postDoc.data().commentsCount || 0) > 0) {\n         await updateDoc(postRef, {\n-          commentsCount: postDoc.data().commentsCount - 1,\n+          commentsCount: (postDoc.data().commentsCount || 0) - 1,\n         });\n       }\n     } catch (err) {\n       console.error(\"Error al eliminar comentario:\", err);\n"
                },
                {
                    "date": 1755804083235,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -74,8 +74,9 @@\n     return () => unsubscribe();\n   }, []);\n \n   // Escuchar comentarios (CORREGIDO)\n+  // Escuchar comentarios\n   useEffect(() => {\n     const unsubs = [];\n \n     posts.forEach((post) => {\n@@ -91,16 +92,17 @@\n           const commentList = snapshot.docs.map((doc) => ({\n             id: doc.id,\n             ...doc.data(),\n           }));\n-          setComments((prev) => ({ ...prev, [post.id]: commentList }));\n+\n+          // Inicializar como array vac√≠o si no existe\n+          setComments((prev) => ({\n+            ...prev,\n+            [post.id]: commentList || [],\n+          }));\n         },\n         (error) => {\n-          console.error(\n-            \"Error al escuchar comentarios del post:\",\n-            post.id,\n-            error\n-          );\n+          console.error(\"Error al escuchar comentarios:\", error);\n         }\n       );\n \n       unsubs.push(unsub);\n"
                },
                {
                    "date": 1755804128453,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,45 +73,26 @@\n \n     return () => unsubscribe();\n   }, []);\n \n-  // Escuchar comentarios (CORREGIDO)\n   // Escuchar comentarios\n   useEffect(() => {\n-    const unsubs = [];\n-\n-    posts.forEach((post) => {\n+    const unsubscribeAll = posts.map((post) => {\n       const q = query(\n         collection(db, \"comments\"),\n         where(\"postId\", \"==\", post.id),\n         orderBy(\"createdAt\", \"asc\")\n       );\n-\n-      const unsub = onSnapshot(\n-        q,\n-        (snapshot) => {\n-          const commentList = snapshot.docs.map((doc) => ({\n-            id: doc.id,\n-            ...doc.data(),\n-          }));\n-\n-          // Inicializar como array vac√≠o si no existe\n-          setComments((prev) => ({\n-            ...prev,\n-            [post.id]: commentList || [],\n-          }));\n-        },\n-        (error) => {\n-          console.error(\"Error al escuchar comentarios:\", error);\n-        }\n-      );\n-\n-      unsubs.push(unsub);\n+      return onSnapshot(q, (snapshot) => {\n+        const commentList = snapshot.docs.map((doc) => ({\n+          id: doc.id,\n+          ...doc.data(),\n+        }));\n+        setComments((prev) => ({ ...prev, [post.id]: commentList }));\n+      });\n     });\n \n-    return () => {\n-      unsubs.forEach((unsub) => unsub());\n-    };\n+    return () => unsubscribeAll.forEach((unsub) => unsub && unsub());\n   }, [posts]);\n \n   // Crear publicaci√≥n\n   const handleCreatePost = async (e) => {\n@@ -183,9 +164,9 @@\n       const postRef = doc(db, \"forums\", postId);\n       const postDoc = await getDoc(postRef);\n       if (postDoc.exists()) {\n         await updateDoc(postRef, {\n-          commentsCount: (postDoc.data().commentsCount || 0) + 1,\n+          commentsCount: postDoc.data().commentsCount + 1,\n         });\n       }\n     } catch (err) {\n       console.error(\"Error al comentar:\", err);\n@@ -242,11 +223,11 @@\n \n       // Reducir contador\n       const postRef = doc(db, \"forums\", postId);\n       const postDoc = await getDoc(postRef);\n-      if (postDoc.exists() && (postDoc.data().commentsCount || 0) > 0) {\n+      if (postDoc.exists() && postDoc.data().commentsCount > 0) {\n         await updateDoc(postRef, {\n-          commentsCount: (postDoc.data().commentsCount || 0) - 1,\n+          commentsCount: postDoc.data().commentsCount - 1,\n         });\n       }\n     } catch (err) {\n       console.error(\"Error al eliminar comentario:\", err);\n"
                },
                {
                    "date": 1755822857357,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -62,37 +62,76 @@\n \n   // Escuchar publicaciones en tiempo real\n   useEffect(() => {\n     const q = query(collection(db, \"forums\"), orderBy(\"createdAt\", \"desc\"));\n-    const unsubscribe = onSnapshot(q, (snapshot) => {\n-      const postsList = snapshot.docs.map((doc) => ({\n-        id: doc.id,\n-        ...doc.data(),\n-      }));\n-      setPosts(postsList);\n-    });\n+    const unsubscribe = onSnapshot(\n+      q,\n+      (snapshot) => {\n+        const postsList = snapshot.docs.map((doc) => ({\n+          id: doc.id,\n+          ...doc.data(),\n+        }));\n+        setPosts(postsList);\n+      },\n+      (err) => {\n+        console.error(\"Error al escuchar publicaciones:\", err);\n+        setError(\"No se pudieron cargar las publicaciones.\");\n+      }\n+    );\n \n     return () => unsubscribe();\n   }, []);\n \n-  // Escuchar comentarios\n+  // ‚úÖ Escuchar comentarios (CORREGIDO Y ROBUSTO)\n   useEffect(() => {\n-    const unsubscribeAll = posts.map((post) => {\n+    const unsubs = [];\n+\n+    posts.forEach((post) => {\n       const q = query(\n         collection(db, \"comments\"),\n         where(\"postId\", \"==\", post.id),\n         orderBy(\"createdAt\", \"asc\")\n       );\n-      return onSnapshot(q, (snapshot) => {\n-        const commentList = snapshot.docs.map((doc) => ({\n-          id: doc.id,\n-          ...doc.data(),\n-        }));\n-        setComments((prev) => ({ ...prev, [post.id]: commentList }));\n-      });\n+\n+      const unsub = onSnapshot(\n+        q,\n+        (snapshot) => {\n+          const commentList = snapshot.docs.map((doc) => {\n+            const data = doc.data();\n+            return {\n+              id: doc.id,\n+              postId: data.postId,\n+              userId: data.userId,\n+              userName: data.userName || \"Usuario\",\n+              userPhoto: data.userPhoto || null,\n+              content: data.content || \"\",\n+              createdAt: data.createdAt || null,\n+            };\n+          });\n+\n+          // ‚úÖ Aseguramos que siempre sea un array\n+          setComments((prev) => ({\n+            ...prev,\n+            [post.id]: Array.isArray(commentList) ? commentList : [],\n+          }));\n+        },\n+        (err) => {\n+          console.error(\n+            \"Error al escuchar comentarios del post:\",\n+            post.id,\n+            err\n+          );\n+          // ‚úÖ Aseguramos que no quede en estado inv√°lido\n+          setComments((prev) => ({ ...prev, [post.id]: [] }));\n+        }\n+      );\n+\n+      unsubs.push(unsub);\n     });\n \n-    return () => unsubscribeAll.forEach((unsub) => unsub && unsub());\n+    return () => {\n+      unsubs.forEach((unsub) => unsub());\n+    };\n   }, [posts]);\n \n   // Crear publicaci√≥n\n   const handleCreatePost = async (e) => {\n@@ -164,9 +203,9 @@\n       const postRef = doc(db, \"forums\", postId);\n       const postDoc = await getDoc(postRef);\n       if (postDoc.exists()) {\n         await updateDoc(postRef, {\n-          commentsCount: postDoc.data().commentsCount + 1,\n+          commentsCount: (postDoc.data().commentsCount || 0) + 1,\n         });\n       }\n     } catch (err) {\n       console.error(\"Error al comentar:\", err);\n@@ -217,17 +256,17 @@\n \n       // Actualizar estado local\n       setComments((prev) => ({\n         ...prev,\n-        [postId]: prev[postId]?.filter((c) => c.id !== commentId),\n+        [postId]: prev[postId]?.filter((c) => c.id !== commentId) || [],\n       }));\n \n       // Reducir contador\n       const postRef = doc(db, \"forums\", postId);\n       const postDoc = await getDoc(postRef);\n-      if (postDoc.exists() && postDoc.data().commentsCount > 0) {\n+      if (postDoc.exists() && (postDoc.data().commentsCount || 0) > 0) {\n         await updateDoc(postRef, {\n-          commentsCount: postDoc.data().commentsCount - 1,\n+          commentsCount: (postDoc.data().commentsCount || 0) - 1,\n         });\n       }\n     } catch (err) {\n       console.error(\"Error al eliminar comentario:\", err);\n@@ -420,18 +459,18 @@\n                       <h4 className=\"font-medium text-gray-800 mb-3\">\n                         Comentarios\n                       </h4>\n \n-                      {comments[post.id]?.length > 0 ? (\n+                      {comments[post.id] && comments[post.id].length > 0 ? (\n                         <ul className=\"space-y-3 mb-4\">\n                           {comments[post.id].map((comment) => (\n                             <li\n                               key={comment.id}\n                               className=\"flex gap-3 bg-gray-50 p-3 rounded-lg\"\n                             >\n                               <img\n                                 src={\n-                                  comment.userPhoto ||\n+                                  comment.userPhoto ??\n                                   \"/img/user-placeholder.jpg\"\n                                 }\n                                 alt={comment.userName}\n                                 className=\"w-8 h-8 rounded-full object-cover border\"\n"
                },
                {
                    "date": 1755823084847,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -187,10 +187,13 @@\n \n     try {\n       const userPhotoURL = userData?.photoURL || user?.photoURL || null;\n \n+      // Aseguramos que postId sea string\n+      const postIdStr = String(postId);\n+\n       await addDoc(collection(db, \"comments\"), {\n-        postId,\n+        postId: postIdStr,\n         userId: user.uid,\n         userName: userData?.name || \"Usuario\",\n         userPhoto: userPhotoURL,\n         content,\n"
                },
                {
                    "date": 1755823161123,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,12 +8,10 @@\n   query,\n   where,\n   getDocs,\n   addDoc,\n-  getDoc,\n   updateDoc,\n   doc,\n-  deleteDoc,\n   serverTimestamp,\n   orderBy,\n   onSnapshot,\n } from \"firebase/firestore\";\n@@ -24,8 +22,9 @@\n   const [userData, setUserData] = useState(null);\n   const [posts, setPosts] = useState([]);\n   const [newPost, setNewPost] = useState(\"\");\n   const [image, setImage] = useState(\"\");\n+  const [uploading, setUploading] = useState(false);\n   const [error, setError] = useState(\"\");\n   const [loading, setLoading] = useState(true);\n   const [comments, setComments] = useState({});\n   const [newComment, setNewComment] = useState({});\n@@ -62,84 +61,46 @@\n \n   // Escuchar publicaciones en tiempo real\n   useEffect(() => {\n     const q = query(collection(db, \"forums\"), orderBy(\"createdAt\", \"desc\"));\n-    const unsubscribe = onSnapshot(\n-      q,\n-      (snapshot) => {\n-        const postsList = snapshot.docs.map((doc) => ({\n-          id: doc.id,\n-          ...doc.data(),\n-        }));\n-        setPosts(postsList);\n-      },\n-      (err) => {\n-        console.error(\"Error al escuchar publicaciones:\", err);\n-        setError(\"No se pudieron cargar las publicaciones.\");\n-      }\n-    );\n+    const unsubscribe = onSnapshot(q, (snapshot) => {\n+      const postsList = snapshot.docs.map((doc) => ({\n+        id: doc.id,\n+        ...doc.data(),\n+      }));\n+      setPosts(postsList);\n+    });\n \n     return () => unsubscribe();\n   }, []);\n \n-  // ‚úÖ Escuchar comentarios (CORREGIDO Y ROBUSTO)\n+  // Escuchar comentarios\n   useEffect(() => {\n-    const unsubs = [];\n-\n-    posts.forEach((post) => {\n+    const unsubscribeAll = posts.map((post) => {\n       const q = query(\n         collection(db, \"comments\"),\n         where(\"postId\", \"==\", post.id),\n         orderBy(\"createdAt\", \"asc\")\n       );\n-\n-      const unsub = onSnapshot(\n-        q,\n-        (snapshot) => {\n-          const commentList = snapshot.docs.map((doc) => {\n-            const data = doc.data();\n-            return {\n-              id: doc.id,\n-              postId: data.postId,\n-              userId: data.userId,\n-              userName: data.userName || \"Usuario\",\n-              userPhoto: data.userPhoto || null,\n-              content: data.content || \"\",\n-              createdAt: data.createdAt || null,\n-            };\n-          });\n-\n-          // ‚úÖ Aseguramos que siempre sea un array\n-          setComments((prev) => ({\n-            ...prev,\n-            [post.id]: Array.isArray(commentList) ? commentList : [],\n-          }));\n-        },\n-        (err) => {\n-          console.error(\n-            \"Error al escuchar comentarios del post:\",\n-            post.id,\n-            err\n-          );\n-          // ‚úÖ Aseguramos que no quede en estado inv√°lido\n-          setComments((prev) => ({ ...prev, [post.id]: [] }));\n-        }\n-      );\n-\n-      unsubs.push(unsub);\n+      return onSnapshot(q, (snapshot) => {\n+        const commentList = snapshot.docs.map((doc) => ({\n+          id: doc.id,\n+          ...doc.data(),\n+        }));\n+        setComments((prev) => ({ ...prev, [post.id]: commentList }));\n+      });\n     });\n \n-    return () => {\n-      unsubs.forEach((unsub) => unsub());\n-    };\n+    return () => unsubscribeAll.forEach((unsub) => unsub && unsub());\n   }, [posts]);\n \n   // Crear publicaci√≥n\n   const handleCreatePost = async (e) => {\n     e.preventDefault();\n     if (!newPost.trim()) return;\n \n     try {\n+      // Priorizar foto del perfil, luego auth, luego null\n       const userPhotoURL = userData?.photoURL || user?.photoURL || null;\n \n       await addDoc(collection(db, \"forums\"), {\n         content: newPost.trim(),\n@@ -187,13 +148,10 @@\n \n     try {\n       const userPhotoURL = userData?.photoURL || user?.photoURL || null;\n \n-      // Aseguramos que postId sea string\n-      const postIdStr = String(postId);\n-\n       await addDoc(collection(db, \"comments\"), {\n-        postId: postIdStr,\n+        postId,\n         userId: user.uid,\n         userName: userData?.name || \"Usuario\",\n         userPhoto: userPhotoURL,\n         content,\n@@ -201,83 +159,21 @@\n       });\n \n       setNewComment({ ...newComment, [postId]: \"\" });\n \n-      // Actualizar contador\n+      // Actualizar contador de comentarios\n       const postRef = doc(db, \"forums\", postId);\n       const postDoc = await getDoc(postRef);\n       if (postDoc.exists()) {\n         await updateDoc(postRef, {\n-          commentsCount: (postDoc.data().commentsCount || 0) + 1,\n+          commentsCount: postDoc.data().commentsCount + 1,\n         });\n       }\n     } catch (err) {\n       console.error(\"Error al comentar:\", err);\n     }\n   };\n \n-  // Eliminar publicaci√≥n\n-  const handleDeletePost = async (postId) => {\n-    if (\n-      !window.confirm(\"¬øEst√°s seguro de que quieres eliminar esta publicaci√≥n?\")\n-    )\n-      return;\n-\n-    try {\n-      const postRef = doc(db, \"forums\", postId);\n-      await deleteDoc(postRef);\n-\n-      // Eliminar comentarios asociados\n-      const commentsSnapshot = await getDocs(\n-        query(collection(db, \"comments\"), where(\"postId\", \"==\", postId))\n-      );\n-      commentsSnapshot.forEach(async (commentDoc) => {\n-        await deleteDoc(doc(db, \"comments\", commentDoc.id));\n-      });\n-\n-      // Actualizar estado local\n-      setPosts(posts.filter((p) => p.id !== postId));\n-      setComments((prev) => {\n-        const updated = { ...prev };\n-        delete updated[postId];\n-        return updated;\n-      });\n-    } catch (err) {\n-      console.error(\"Error al eliminar publicaci√≥n:\", err);\n-      setError(\"No se pudo eliminar la publicaci√≥n.\");\n-    }\n-  };\n-\n-  // Eliminar comentario\n-  const handleDeleteComment = async (postId, commentId) => {\n-    if (\n-      !window.confirm(\"¬øEst√°s seguro de que quieres eliminar este comentario?\")\n-    )\n-      return;\n-\n-    try {\n-      await deleteDoc(doc(db, \"comments\", commentId));\n-\n-      // Actualizar estado local\n-      setComments((prev) => ({\n-        ...prev,\n-        [postId]: prev[postId]?.filter((c) => c.id !== commentId) || [],\n-      }));\n-\n-      // Reducir contador\n-      const postRef = doc(db, \"forums\", postId);\n-      const postDoc = await getDoc(postRef);\n-      if (postDoc.exists() && (postDoc.data().commentsCount || 0) > 0) {\n-        await updateDoc(postRef, {\n-          commentsCount: (postDoc.data().commentsCount || 0) - 1,\n-        });\n-      }\n-    } catch (err) {\n-      console.error(\"Error al eliminar comentario:\", err);\n-      setError(\"No se pudo eliminar el comentario.\");\n-    }\n-  };\n-\n   // Formatear fecha\n   const formatTimeAgo = (timestamp) => {\n     if (!timestamp) return \"ahora\";\n     const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);\n@@ -312,8 +208,9 @@\n           <p className=\"text-gray-600 mb-6\">\n             Comparte ideas, dudas y conocimientos con la comunidad.\n           </p>\n \n+          {/* Mostrar error */}\n           {error && (\n             <div className=\"mb-4 p-3 bg-red-100 text-red-700 rounded\">\n               {error}\n             </div>\n@@ -364,53 +261,36 @@\n             ) : (\n               posts.map((post) => (\n                 <div key={post.id} className=\"bg-white p-6 rounded-lg shadow\">\n                   {/* Cabecera */}\n-                  <div className=\"flex items-center justify-between mb-4\">\n-                    <div className=\"flex items-center gap-3\">\n-                      <img\n-                        src={post.userPhoto || \"/img/user-placeholder.jpg\"}\n-                        alt={post.userName}\n-                        className=\"w-10 h-10 rounded-full object-cover border\"\n-                        onError={(e) => {\n-                          e.target.src = \"/img/user-placeholder.jpg\";\n-                        }}\n-                      />\n-                      <div>\n-                        <p className=\"font-medium text-gray-800\">\n-                          {post.userName}\n-                        </p>\n-                        <p className=\"text-xs text-gray-500\">\n-                          {formatTimeAgo(post.createdAt)} ¬∑{\" \"}\n-                          <span\n-                            className={`${\n-                              post.userRole === \"admin\"\n-                                ? \"text-purple-600 bg-purple-100\"\n-                                : post.userRole === \"teacher\"\n-                                ? \"text-indigo-600 bg-indigo-100\"\n-                                : \"text-green-600 bg-green-100\"\n-                            } px-1.5 py-0.5 rounded text-xs font-medium`}\n-                          >\n-                            {post.userRole === \"admin\"\n-                              ? \"Direcci√≥n\"\n-                              : post.userRole === \"teacher\"\n-                              ? \"Profesor\"\n-                              : \"Estudiante\"}\n-                          </span>\n-                        </p>\n-                      </div>\n+                  <div className=\"flex items-center gap-3 mb-4\">\n+                    <img\n+                      src={post.userPhoto || \"/img/user-placeholder.jpg\"}\n+                      alt={post.userName}\n+                      className=\"w-10 h-10 rounded-full object-cover border\"\n+                      onError={(e) => {\n+                        e.target.src = \"/img/user-placeholder.jpg\";\n+                      }}\n+                    />\n+                    <div>\n+                      <p className=\"font-medium text-gray-800\">\n+                        {post.userName}\n+                      </p>\n+                      <p className=\"text-xs text-gray-500\">\n+                        {formatTimeAgo(post.createdAt)} ¬∑{\" \"}\n+                        <span\n+                          className={`${\n+                            post.userRole === \"teacher\"\n+                              ? \"text-indigo-600 bg-indigo-100\"\n+                              : \"text-green-600 bg-green-100\"\n+                          } px-1.5 py-0.5 rounded text-xs`}\n+                        >\n+                          {post.userRole === \"teacher\"\n+                            ? \"Profesor\"\n+                            : \"Estudiante\"}\n+                        </span>\n+                      </p>\n                     </div>\n-\n-                    {/* Bot√≥n de eliminar (solo si es el autor) */}\n-                    {post.userId === user.uid && (\n-                      <button\n-                        onClick={() => handleDeletePost(post.id)}\n-                        className=\"text-red-500 hover:text-red-700 text-lg\"\n-                        title=\"Eliminar publicaci√≥n\"\n-                      >\n-                        üóëÔ∏è\n-                      </button>\n-                    )}\n                   </div>\n \n                   {/* Contenido */}\n                   <p className=\"text-gray-700 mb-4 whitespace-pre-wrap\">\n@@ -462,43 +342,28 @@\n                       <h4 className=\"font-medium text-gray-800 mb-3\">\n                         Comentarios\n                       </h4>\n \n-                      {comments[post.id] && comments[post.id].length > 0 ? (\n+                      {/* Lista de comentarios */}\n+                      {comments[post.id]?.length > 0 ? (\n                         <ul className=\"space-y-3 mb-4\">\n                           {comments[post.id].map((comment) => (\n-                            <li\n-                              key={comment.id}\n-                              className=\"flex gap-3 bg-gray-50 p-3 rounded-lg\"\n-                            >\n+                            <li key={comment.id} className=\"flex gap-3\">\n                               <img\n                                 src={\n-                                  comment.userPhoto ??\n+                                  comment.userPhoto ||\n                                   \"/img/user-placeholder.jpg\"\n                                 }\n                                 alt={comment.userName}\n                                 className=\"w-8 h-8 rounded-full object-cover border\"\n                                 onError={(e) => {\n                                   e.target.src = \"/img/user-placeholder.jpg\";\n                                 }}\n                               />\n-                              <div className=\"flex-1\">\n-                                <div className=\"flex items-center justify-between\">\n-                                  <p className=\"text-sm font-medium text-gray-800\">\n-                                    {comment.userName}\n-                                  </p>\n-                                  {comment.userId === user.uid && (\n-                                    <button\n-                                      onClick={() =>\n-                                        handleDeleteComment(post.id, comment.id)\n-                                      }\n-                                      className=\"text-red-500 hover:text-red-700 text-xs\"\n-                                      title=\"Eliminar comentario\"\n-                                    >\n-                                      üóëÔ∏è\n-                                    </button>\n-                                  )}\n-                                </div>\n+                              <div>\n+                                <p className=\"text-sm font-medium text-gray-800\">\n+                                  {comment.userName}\n+                                </p>\n                                 <p className=\"text-sm text-gray-600\">\n                                   {comment.content}\n                                 </p>\n                                 <p className=\"text-xs text-gray-400\">\n"
                },
                {
                    "date": 1755823167690,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,9 +6,9 @@\n import {\n   collection,\n   query,\n   where,\n-  getDocs,\n+  getDoc,\n   addDoc,\n   updateDoc,\n   doc,\n   serverTimestamp,\n"
                },
                {
                    "date": 1755823248558,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,8 +6,9 @@\n import {\n   collection,\n   query,\n   where,\n+  getDocs,\n   getDoc,\n   addDoc,\n   updateDoc,\n   doc,\n"
                },
                {
                    "date": 1755823273746,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -78,9 +78,9 @@\n   useEffect(() => {\n     const unsubscribeAll = posts.map((post) => {\n       const q = query(\n         collection(db, \"comments\"),\n-        where(\"postId\", \"==\", post.id),\n+        where(\"postId\", \"==\", post.uid),\n         orderBy(\"createdAt\", \"asc\")\n       );\n       return onSnapshot(q, (snapshot) => {\n         const commentList = snapshot.docs.map((doc) => ({\n"
                },
                {
                    "date": 1755823303182,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -78,9 +78,9 @@\n   useEffect(() => {\n     const unsubscribeAll = posts.map((post) => {\n       const q = query(\n         collection(db, \"comments\"),\n-        where(\"postId\", \"==\", post.uid),\n+        where(\"postId\", \"==\", post?.uid),\n         orderBy(\"createdAt\", \"asc\")\n       );\n       return onSnapshot(q, (snapshot) => {\n         const commentList = snapshot.docs.map((doc) => ({\n"
                },
                {
                    "date": 1755823312426,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -78,9 +78,9 @@\n   useEffect(() => {\n     const unsubscribeAll = posts.map((post) => {\n       const q = query(\n         collection(db, \"comments\"),\n-        where(\"postId\", \"==\", post?.uid),\n+        where(\"postId\", \"==\", post.id),\n         orderBy(\"createdAt\", \"asc\")\n       );\n       return onSnapshot(q, (snapshot) => {\n         const commentList = snapshot.docs.map((doc) => ({\n"
                },
                {
                    "date": 1755823627793,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -74,25 +74,59 @@\n     return () => unsubscribe();\n   }, []);\n \n   // Escuchar comentarios\n+  // Escuchar comentarios\n   useEffect(() => {\n-    const unsubscribeAll = posts.map((post) => {\n+    const unsubs = [];\n+\n+    posts.forEach((post) => {\n+      // Aseguramos que post.id sea string\n+      const postId = String(post.id);\n+\n       const q = query(\n         collection(db, \"comments\"),\n-        where(\"postId\", \"==\", post.id),\n+        where(\"postId\", \"==\", postId),\n         orderBy(\"createdAt\", \"asc\")\n       );\n-      return onSnapshot(q, (snapshot) => {\n-        const commentList = snapshot.docs.map((doc) => ({\n-          id: doc.id,\n-          ...doc.data(),\n-        }));\n-        setComments((prev) => ({ ...prev, [post.id]: commentList }));\n-      });\n+\n+      const unsub = onSnapshot(\n+        q,\n+        (snapshot) => {\n+          console.log(\n+            `‚úÖ Comentarios para post ${postId}: ${snapshot.docs.length} encontrados`\n+          );\n+\n+          const commentList = snapshot.docs.map((doc) => ({\n+            id: doc.id,\n+            ...doc.data(),\n+          }));\n+\n+          setComments((prev) => ({\n+            ...prev,\n+            [postId]: commentList,\n+          }));\n+        },\n+        (error) => {\n+          console.error(\n+            `‚ùå Error al escuchar comentarios del post ${postId}:`,\n+            error\n+          );\n+          if (error.code === \"failed-precondition\") {\n+            console.warn(\n+              `üö® Necesitas crear un √≠ndice compuesto para 'postId' y 'createdAt'. ` +\n+                `Ve al enlace en la consola de Firebase.`\n+            );\n+          }\n+        }\n+      );\n+\n+      unsubs.push(unsub);\n     });\n \n-    return () => unsubscribeAll.forEach((unsub) => unsub && unsub());\n+    return () => {\n+      unsubs.forEach((unsub) => unsub());\n+    };\n   }, [posts]);\n \n   // Crear publicaci√≥n\n   const handleCreatePost = async (e) => {\n"
                },
                {
                    "date": 1755823686715,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -121,9 +121,21 @@\n       );\n \n       unsubs.push(unsub);\n     });\n-\n+    {\n+      /* üîç Depuraci√≥n: Muestra estado actual */\n+    }\n+    {\n+      (() => {\n+        console.log(\n+          \"üîß Posts cargados:\",\n+          posts.map((p) => p.id)\n+        );\n+        console.log(\"üí¨ Estado actual de comments:\", comments);\n+        return null;\n+      })();\n+    }\n     return () => {\n       unsubs.forEach((unsub) => unsub());\n     };\n   }, [posts]);\n"
                },
                {
                    "date": 1755825020518,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -325,14 +325,18 @@\n                       <p className=\"text-xs text-gray-500\">\n                         {formatTimeAgo(post.createdAt)} ¬∑{\" \"}\n                         <span\n                           className={`${\n-                            post.userRole === \"teacher\"\n+                            post.userRole === \"admin\"\n+                              ? \"text-purple-600 bg-purple-100\"\n+                              : post.userRole === \"teacher\"\n                               ? \"text-indigo-600 bg-indigo-100\"\n                               : \"text-green-600 bg-green-100\"\n-                          } px-1.5 py-0.5 rounded text-xs`}\n+                          } px-1.5 py-0.5 rounded text-xs font-medium`}\n                         >\n-                          {post.userRole === \"teacher\"\n+                          {post.userRole === \"admin\"\n+                            ? \"Direcci√≥n\"\n+                            : post.userRole === \"teacher\"\n                             ? \"Profesor\"\n                             : \"Estudiante\"}\n                         </span>\n                       </p>\n"
                },
                {
                    "date": 1755825357298,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -247,9 +247,9 @@\n   return (\n     <>\n       <Navbar user={user} userData={userData} />\n       <div className=\"min-h-screen bg-gray-50 py-8\">\n-        <div className=\"max-w-3xl mx-auto px-4\">\n+        <div className=\"max-w-4xl mx-auto px-4\">\n           <h1 className=\"text-3xl font-bold text-gray-800 mb-6\">\n             Foro Educativo\n           </h1>\n           <p className=\"text-gray-600 mb-6\">\n"
                },
                {
                    "date": 1755825378743,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -246,9 +246,9 @@\n \n   return (\n     <>\n       <Navbar user={user} userData={userData} />\n-      <div className=\"min-h-screen bg-gray-50 py-8\">\n+      <div className=\"min-h-screen flex justify-center gap-6 bg-gray-50 py-8\">\n         <div className=\"max-w-4xl mx-auto px-4\">\n           <h1 className=\"text-3xl font-bold text-gray-800 mb-6\">\n             Foro Educativo\n           </h1>\n"
                },
                {
                    "date": 1755825475830,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -246,9 +246,9 @@\n \n   return (\n     <>\n       <Navbar user={user} userData={userData} />\n-      <div className=\"min-h-screen flex justify-center gap-6 bg-gray-50 py-8\">\n+      <div className=\"min-h-screen flex justify-center gap-6 bg-[#f4f2ee] py-8\">\n         <div className=\"max-w-4xl mx-auto px-4\">\n           <h1 className=\"text-3xl font-bold text-gray-800 mb-6\">\n             Foro Educativo\n           </h1>\n"
                },
                {
                    "date": 1755825490259,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -246,9 +246,9 @@\n \n   return (\n     <>\n       <Navbar user={user} userData={userData} />\n-      <div className=\"min-h-screen flex justify-center gap-6 bg-[#f4f2ee] py-8\">\n+      <div className=\"min-h-screen flex justify-center gap-6 bg-purple-50 py-8\">\n         <div className=\"max-w-4xl mx-auto px-4\">\n           <h1 className=\"text-3xl font-bold text-gray-800 mb-6\">\n             Foro Educativo\n           </h1>\n"
                },
                {
                    "date": 1755825507635,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -249,9 +249,9 @@\n       <Navbar user={user} userData={userData} />\n       <div className=\"min-h-screen flex justify-center gap-6 bg-purple-50 py-8\">\n         <div className=\"max-w-4xl mx-auto px-4\">\n           <h1 className=\"text-3xl font-bold text-gray-800 mb-6\">\n-            Foro Educativo\n+            Forum Educativo\n           </h1>\n           <p className=\"text-gray-600 mb-6\">\n             Comparte ideas, dudas y conocimientos con la comunidad.\n           </p>\n"
                },
                {
                    "date": 1755827638609,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -245,9 +245,8 @@\n   }\n \n   return (\n     <>\n-      <Navbar user={user} userData={userData} />\n       <div className=\"min-h-screen flex justify-center gap-6 bg-purple-50 py-8\">\n         <div className=\"max-w-4xl mx-auto px-4\">\n           <h1 className=\"text-3xl font-bold text-gray-800 mb-6\">\n             Forum Educativo\n"
                }
            ],
            "date": 1755795579280,
            "name": "Commit-0",
            "content": "// pages/forum.js\nimport { useEffect, useState } from \"react\";\nimport { useRouter } from \"next/router\";\nimport { useAuthState } from \"react-firebase-hooks/auth\";\nimport { auth, db } from \"../lib/firebase\";\nimport {\n  collection,\n  query,\n  where,\n  getDocs,\n  addDoc,\n  updateDoc,\n  doc,\n  serverTimestamp,\n  orderBy,\n  onSnapshot,\n} from \"firebase/firestore\";\nimport Navbar from \"../components/Navbar\";\n\nexport default function ForumPage() {\n  const [user, loadingAuth] = useAuthState(auth);\n  const [userData, setUserData] = useState(null);\n  const [posts, setPosts] = useState([]);\n  const [newPost, setNewPost] = useState(\"\");\n  const [image, setImage] = useState(\"\");\n  const [uploading, setUploading] = useState(false);\n  const [error, setError] = useState(\"\");\n  const [loading, setLoading] = useState(true);\n  const [comments, setComments] = useState({});\n  const [newComment, setNewComment] = useState({});\n  const [showComments, setShowComments] = useState({});\n\n  const router = useRouter();\n\n  // Cargar datos del usuario\n  useEffect(() => {\n    if (loadingAuth) return;\n    if (!user) {\n      router.push(\"/login\");\n      return;\n    }\n\n    const loadUserData = async () => {\n      const userDoc = await getDoc(doc(db, \"users\", user.uid));\n      if (!userDoc.exists()) {\n        router.push(\"/register\");\n        return;\n      }\n      setUserData(userDoc.data());\n      setLoading(false);\n    };\n\n    loadUserData();\n  }, [user, loadingAuth, router]);\n\n  // Escuchar publicaciones en tiempo real\n  useEffect(() => {\n    const q = query(collection(db, \"forums\"), orderBy(\"createdAt\", \"desc\"));\n    const unsubscribe = onSnapshot(q, (snapshot) => {\n      const postsList = snapshot.docs.map((doc) => ({\n        id: doc.id,\n        ...doc.data(),\n      }));\n      setPosts(postsList);\n    });\n\n    return () => unsubscribe();\n  }, []);\n\n  // Escuchar comentarios\n  useEffect(() => {\n    const unsubscribeAll = posts.map((post) => {\n      const q = query(\n        collection(db, \"comments\"),\n        where(\"postId\", \"==\", post.id),\n        orderBy(\"createdAt\", \"asc\")\n      );\n      return onSnapshot(q, (snapshot) => {\n        const commentList = snapshot.docs.map((doc) => ({\n          id: doc.id,\n          ...doc.data(),\n        }));\n        setComments((prev) => ({ ...prev, [post.id]: commentList }));\n      });\n    });\n\n    return () => unsubscribeAll.forEach((unsub) => unsub && unsub());\n  }, [posts]);\n\n  // Crear publicaci√≥n\n  const handleCreatePost = async (e) => {\n    e.preventDefault();\n    if (!newPost.trim()) return;\n\n    try {\n      await addDoc(collection(db, \"forums\"), {\n        content: newPost.trim(),\n        imageUrl: image || null,\n        userId: user.uid,\n        userName: userData.name,\n        userPhoto: user.photoURL || null,\n        userRole: userData.role,\n        likes: [],\n        commentsCount: 0,\n        createdAt: serverTimestamp(),\n      });\n\n      setNewPost(\"\");\n      setImage(\"\");\n    } catch (err) {\n      setError(\"No se pudo crear la publicaci√≥n.\");\n      console.error(err);\n    }\n  };\n\n  // Dar like\n  const handleLike = async (post) => {\n    if (!user) return;\n\n    const postRef = doc(db, \"forums\", post.id);\n    const hasLiked = post.likes.includes(user.uid);\n\n    await updateDoc(postRef, {\n      likes: hasLiked\n        ? post.likes.filter((id) => id !== user.uid)\n        : [...post.likes, user.uid],\n    });\n  };\n\n  // Agregar comentario\n  const handleAddComment = async (postId) => {\n    const content = newComment[postId]?.trim();\n    if (!content) return;\n\n    try {\n      await addDoc(collection(db, \"comments\"), {\n        postId,\n        userId: user.uid,\n        userName: userData.name,\n        userPhoto: user.photoURL || null,\n        content,\n        createdAt: serverTimestamp(),\n      });\n\n      setNewComment({ ...newComment, [postId]: \"\" });\n\n      // Actualizar contador\n      const postRef = doc(db, \"forums\", postId);\n      const postDoc = await getDoc(postRef);\n      if (postDoc.exists()) {\n        await updateDoc(postRef, {\n          commentsCount: postDoc.data().commentsCount + 1,\n        });\n      }\n    } catch (err) {\n      console.error(\"Error al comentar:\", err);\n    }\n  };\n\n  // Formatear fecha\n  const formatTimeAgo = (timestamp) => {\n    if (!timestamp) return \"ahora\";\n    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);\n    const now = new Date();\n    const diffInHours = (now - date) / (1000 * 60 * 60);\n\n    if (diffInHours < 1) return \"hace unos minutos\";\n    if (diffInHours < 24) return `hace ${Math.floor(diffInHours)}h`;\n    return date.toLocaleDateString();\n  };\n\n  if (loading || loadingAuth) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <p>Cargando foro...</p>\n      </div>\n    );\n  }\n\n  return (\n    <>\n      <Navbar user={user} userData={userData} />\n      <div className=\"min-h-screen bg-gray-50 py-8\">\n        <div className=\"max-w-3xl mx-auto px-4\">\n          <h1 className=\"text-3xl font-bold text-gray-800 mb-6\">\n            Foro Educativo\n          </h1>\n          <p className=\"text-gray-600 mb-6\">\n            Comparte ideas, dudas y conocimientos con la comunidad.\n          </p>\n\n          {/* Crear publicaci√≥n */}\n          <form\n            onSubmit={handleCreatePost}\n            className=\"bg-white p-6 rounded-lg shadow mb-6\"\n          >\n            <textarea\n              value={newPost}\n              onChange={(e) => setNewPost(e.target.value)}\n              placeholder=\"¬øQu√© est√°s pensando?\"\n              className=\"w-full p-3 border border-gray-300 rounded-lg mb-3 resize-none\"\n              rows=\"3\"\n            />\n            <input\n              type=\"text\"\n              value={image}\n              onChange={(e) => setImage(e.target.value)}\n              placeholder=\"URL de imagen (opcional)\"\n              className=\"w-full p-3 border border-gray-300 rounded-lg mb-3\"\n            />\n            {image && (\n              <div className=\"mb-3\">\n                <img\n                  src={image}\n                  alt=\"Vista previa\"\n                  className=\"w-full max-h-60 object-cover rounded-lg\"\n                />\n              </div>\n            )}\n            <button\n              type=\"submit\"\n              className=\"px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg\"\n            >\n              Publicar\n            </button>\n          </form>\n\n          {error && <p className=\"text-red-600 mb-4\">{error}</p>}\n\n          {/* Lista de publicaciones */}\n          <div className=\"space-y-6\">\n            {posts.length === 0 ? (\n              <p className=\"text-gray-500 text-center py-8\">\n                No hay publicaciones a√∫n. ¬°S√© el primero en publicar!\n              </p>\n            ) : (\n              posts.map((post) => (\n                <div key={post.id} className=\"bg-white p-6 rounded-lg shadow\">\n                  {/* Cabecera */}\n                  <div className=\"flex items-center gap-3 mb-4\">\n                    <img\n                      src={post.userPhoto || \"/img/user-placeholder.jpg\"}\n                      alt={post.userName}\n                      className=\"w-10 h-10 rounded-full object-cover border\"\n                    />\n                    <div>\n                      <p className=\"font-medium text-gray-800\">\n                        {post.userName}\n                      </p>\n                      <p className=\"text-xs text-gray-500\">\n                        {formatTimeAgo(post.createdAt)} ¬∑ {post.userRole}\n                      </p>\n                    </div>\n                  </div>\n\n                  {/* Contenido */}\n                  <p className=\"text-gray-700 mb-4 whitespace-pre-wrap\">\n                    {post.content}\n                  </p>\n\n                  {/* Imagen */}\n                  {post.imageUrl && (\n                    <div className=\"mb-4\">\n                      <img\n                        src={post.imageUrl}\n                        alt=\"Publicaci√≥n\"\n                        className=\"w-full max-h-80 object-cover rounded-lg\"\n                      />\n                    </div>\n                  )}\n\n                  {/* Acciones */}\n                  <div className=\"flex items-center gap-6 text-sm\">\n                    <button\n                      onClick={() => handleLike(post)}\n                      className={`flex items-center gap-1 ${\n                        post.likes.includes(user?.uid)\n                          ? \"text-red-600\"\n                          : \"text-gray-500 hover:text-red-600\"\n                      }`}\n                    >\n                      ‚ù§Ô∏è {post.likes.length}\n                    </button>\n                    <button\n                      onClick={() =>\n                        setShowComments((prev) => ({\n                          ...prev,\n                          [post.id]: !prev[post.id],\n                        }))\n                      }\n                      className=\"text-gray-500 hover:text-blue-600 flex items-center gap-1\"\n                    >\n                      üí¨ {post.commentsCount}\n                    </button>\n                  </div>\n\n                  {/* Comentarios */}\n                  {showComments[post.id] && (\n                    <div className=\"mt-6 border-t pt-4\">\n                      <h4 className=\"font-medium text-gray-800 mb-3\">\n                        Comentarios\n                      </h4>\n\n                      {/* Lista de comentarios */}\n                      {comments[post.id]?.length > 0 ? (\n                        <ul className=\"space-y-3 mb-4\">\n                          {comments[post.id].map((comment) => (\n                            <li key={comment.id} className=\"flex gap-3\">\n                              <img\n                                src={\n                                  comment.userPhoto ||\n                                  \"/img/user-placeholder.jpg\"\n                                }\n                                alt={comment.userName}\n                                className=\"w-8 h-8 rounded-full object-cover border\"\n                              />\n                              <div>\n                                <p className=\"text-sm font-medium text-gray-800\">\n                                  {comment.userName}\n                                </p>\n                                <p className=\"text-sm text-gray-600\">\n                                  {comment.content}\n                                </p>\n                                <p className=\"text-xs text-gray-400\">\n                                  {formatTimeAgo(comment.createdAt)}\n                                </p>\n                              </div>\n                            </li>\n                          ))}\n                        </ul>\n                      ) : (\n                        <p className=\"text-gray-500 text-sm mb-4\">\n                          No hay comentarios a√∫n.\n                        </p>\n                      )}\n\n                      {/* Agregar comentario */}\n                      <div className=\"flex gap-2\">\n                        <input\n                          type=\"text\"\n                          value={newComment[post.id] || \"\"}\n                          onChange={(e) =>\n                            setNewComment({\n                              ...newComment,\n                              [post.id]: e.target.value,\n                            })\n                          }\n                          placeholder=\"Escribe un comentario...\"\n                          className=\"flex-1 p-2 border border-gray-300 rounded-lg text-sm\"\n                        />\n                        <button\n                          onClick={() => handleAddComment(post.id)}\n                          className=\"px-4 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-sm rounded\"\n                        >\n                          Enviar\n                        </button>\n                      </div>\n                    </div>\n                  )}\n                </div>\n              ))\n            )}\n          </div>\n        </div>\n      </div>\n    </>\n  );\n}\n"
        }
    ]
}