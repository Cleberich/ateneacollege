{
    "sourceFile": "pages/dashboard2.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1762996267379,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1762996267379,
            "name": "Commit-0",
            "content": "import { useEffect, useState } from \"react\";\nimport { useRouter } from \"next/router\";\nimport { useAuthState } from \"react-firebase-hooks/auth\";\nimport { auth, db } from \"../lib/firebase\";\nimport {\n  doc,\n  getDoc,\n  collection,\n  getDocs,\n  query,\n  where,\n} from \"firebase/firestore\";\nimport Navbar from \"../components/Navbar\";\n\nexport default function Dashboard() {\n  const [user, loading] = useAuthState(auth);\n  const [userData, setUserData] = useState(null);\n  const [enrolledCourses, setEnrolledCourses] = useState([]);\n  const [allCourses, setAllCourses] = useState([]); // Todos los cursos\n  const [createdCourses, setCreatedCourses] = useState([]);\n  const [enrollments, setEnrollments] = useState([]);\n  const [reviews, setReviews] = useState([]);\n  const [selectedCourseReviews, setSelectedCourseReviews] = useState(null);\n  const [userLoaded, setUserLoaded] = useState(false);\n  const router = useRouter();\n\n  useEffect(() => {\n    if (loading) return;\n    if (!user) {\n      router.push(\"/login\");\n      return;\n    }\n\n    const fetchUserData = async () => {\n      try {\n        const userDocRef = doc(db, \"users\", user.uid);\n        const userDocSnap = await getDoc(userDocRef);\n\n        if (!userDocSnap.exists()) {\n          router.push(\"/register\");\n          return;\n        }\n\n        const data = userDocSnap.data();\n        setUserData(data);\n\n        // Cargar cursos del estudiante (inscritos)\n        if (data.role === \"student\") {\n          const enrollmentsRef = collection(db, \"enrollments\");\n          const q = query(enrollmentsRef, where(\"userId\", \"==\", user.uid));\n          const querySnapshot = await getDocs(q);\n\n          const enrolledCourseIds = new Set();\n          const courses = await Promise.all(\n            querySnapshot.docs.map(async (enrollmentDoc) => {\n              const courseId = enrollmentDoc.data().courseId;\n              enrolledCourseIds.add(courseId);\n\n              const courseDoc = await getDoc(doc(db, \"courses\", courseId));\n              if (courseDoc.exists()) {\n                const courseData = courseDoc.data();\n                const enrollmentData = enrollmentDoc.data();\n\n                let courseRating = null;\n                const reviewsRef = collection(db, \"reviews\");\n                const r = query(\n                  reviewsRef,\n                  where(\"courseId\", \"==\", courseId),\n                  where(\"userId\", \"==\", user.uid)\n                );\n                const reviewSnap = await getDocs(r);\n                if (!reviewSnap.empty) {\n                  courseRating = reviewSnap.docs[0].data().rating;\n                }\n\n                return {\n                  id: courseDoc.id,\n                  ...courseData,\n                  progress: enrollmentData.progress || [],\n                  grade: courseRating,\n                  isEnrolled: true,\n                };\n              }\n              return null;\n            })\n          );\n\n          setEnrolledCourses(courses.filter(Boolean));\n\n          // Cargar TODOS los cursos\n          const allCoursesSnapshot = await getDocs(collection(db, \"courses\"));\n          const allCoursesList = allCoursesSnapshot.docs.map((doc) => {\n            const courseData = doc.data();\n            const isEnrolled = enrolledCourseIds.has(doc.id);\n\n            return {\n              id: doc.id,\n              ...courseData,\n              isEnrolled, // Marcamos si est√° inscrito\n              progress: isEnrolled\n                ? courses.find((c) => c.id === doc.id)?.progress || []\n                : [],\n              grade: isEnrolled\n                ? courses.find((c) => c.id === doc.id)?.grade\n                : null,\n            };\n          });\n\n          setAllCourses(\n            allCoursesList.sort((a, b) => a.title.localeCompare(b.title))\n          );\n        }\n\n        // Cargar cursos del profesor\n        if (data.role === \"teacher\") {\n          const enrollmentsSnapshot = await getDocs(\n            collection(db, \"enrollments\")\n          );\n          const allEnrollments = enrollmentsSnapshot.docs.map((doc) => ({\n            courseId: doc.data().courseId,\n          }));\n          setEnrollments(allEnrollments);\n\n          const reviewsSnapshot = await getDocs(collection(db, \"reviews\"));\n          const allReviews = reviewsSnapshot.docs.map((doc) => ({\n            id: doc.id,\n            courseId: doc.data().courseId,\n            userId: doc.data().userId,\n            userName: doc.data().userName,\n            rating: doc.data().rating,\n            comment: doc.data().comment || \"\",\n            timestamp:\n              doc.data().timestamp?.toDate().toLocaleDateString() || \"N/A\",\n          }));\n          setReviews(allReviews);\n\n          const usersSnapshot = await getDocs(collection(db, \"users\"));\n          const usersMap = {};\n          usersSnapshot.docs.forEach((doc) => {\n            usersMap[doc.id] = doc.data().name;\n          });\n\n          const coursesRef = collection(db, \"courses\");\n          const q = query(coursesRef, where(\"teacherId\", \"==\", user.uid));\n          const querySnapshot = await getDocs(q);\n\n          const courses = querySnapshot.docs.map((doc) => {\n            const courseId = doc.id;\n            const courseData = doc.data();\n\n            const studentCount = allEnrollments.filter(\n              (e) => e.courseId === courseId\n            ).length;\n            const courseReviews = allReviews.filter(\n              (r) => r.courseId === courseId\n            );\n\n            const averageRating =\n              courseReviews.length > 0\n                ? (\n                    courseReviews.reduce((sum, r) => sum + r.rating, 0) /\n                    courseReviews.length\n                  ).toFixed(1)\n                : \"Sin\";\n\n            return {\n              id: courseId,\n              ...courseData,\n              studentCount,\n              averageRating,\n              reviewCount: courseReviews.length,\n              reviews: courseReviews,\n            };\n          });\n\n          setCreatedCourses(courses);\n        }\n      } catch (err) {\n        console.error(\"Error al cargar el dashboard:\", err);\n      } finally {\n        setUserLoaded(true);\n      }\n    };\n\n    fetchUserData();\n  }, [user, loading, router]);\n\n  // --- Modal: abrir rese√±as ---\n  const openReviewsModal = (course) => {\n    setSelectedCourseReviews(course);\n  };\n\n  // --- Modal: cerrar ---\n  const closeReviewsModal = () => {\n    setSelectedCourseReviews(null);\n  };\n\n  if (loading || !userLoaded) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen bg-gray-50\">\n        <div className=\"text-center\">\n          <div className=\"inline-block w-8 h-8 border-4 border-atenea cursor-pointer py-2 border-t-transparent rounded-full animate-spin mb-3\"></div>\n          <p className=\"text-gray-600\">Cargando...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!user) return null;\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <main className=\"p-6 mx-32\">\n        <h2 className=\"text-2xl font-semibold text-gray-800 mb-6\">\n          Hola, {userData?.name?.split(\" \")[0]} üëã\n        </h2>\n\n        {/* Panel Estudiantes */}\n        {userData?.role === \"student\" && (\n          <section className=\"bg-white p-6 rounded-lg shadow mb-8\">\n            <h3 className=\"text-xl font-medium text-gray-800 mb-4\">\n              Todos los Cursos\n            </h3>\n            {allCourses.length > 0 ? (\n              <div className=\"grid gap-5 md:grid-cols-2 lg:grid-cols-3\">\n                {allCourses.map((course) => (\n                  <div\n                    key={course.id}\n                    className={`shadow-md rounded-lg overflow-hidden hover:shadow-lg transition flex flex-col ${\n                      course.isEnrolled ? \"cursor-pointer\" : \"opacity-60\"\n                    }`}\n                    onClick={() =>\n                      course.isEnrolled && router.push(`/courses/${course.id}`)\n                    }\n                  >\n                    {/* Imagen del curso */}\n                    <div className=\"h-36 bg-gray-200 relative\">\n                      <img\n                        src={course.imageUrl || \"/img/banner.jpg\"}\n                        alt={course.title}\n                        className=\"w-full h-full object-cover\"\n                        onError={(e) => {\n                          e.target.src = \"/img/banner.jpg\";\n                        }}\n                      />\n                      {!course.isEnrolled && (\n                        <div className=\"absolute inset-0 bg-black  flex items-center justify-center\">\n                          <img\n                            src={course.imageUrl || \"/img/banner.jpg\"}\n                            alt={course.title}\n                            className=\"w-full h-full object-cover\"\n                            onError={(e) => {\n                              e.target.src = \"/img/banner.jpg\";\n                            }}\n                          />\n                        </div>\n                      )}\n                    </div>\n                    <div className=\"px-4 mt-1\">\n                      {course.grade !== null ? (\n                        <div className=\"flex items-center mt-2 gap-1\">\n                          <span className=\"text-sm text-gray-700 font-medium\">\n                            Calif:\n                          </span>\n                          <div className=\"flex\">\n                            {[1, 2, 3, 4, 5].map((star) => {\n                              const rating = parseFloat(course.grade);\n                              const isFull = star <= rating;\n                              const isHalf =\n                                star - 0.5 <= rating && star > rating;\n                              const isEmpty = star > rating + 0.5;\n\n                              return (\n                                <span\n                                  key={star}\n                                  className=\"text-yellow-500 text-sm\"\n                                >\n                                  {isFull ? \"‚òÖ\" : isHalf ? \"‚òÜ\" : \"‚òÜ\"}\n                                </span>\n                              );\n                            })}\n                          </div>\n                          <span className=\"text-xs text-gray-500 ml-1\">\n                            ({course.grade})\n                          </span>\n                        </div>\n                      ) : (\n                        <span className=\"text-sm text-gray-500 mt-2 flex items-center gap-1\">\n                          <span>üåü</span> Sin calificaci√≥n a√∫n\n                        </span>\n                      )}\n                    </div>\n                    <div className=\"-mt-2 p-4 flex-1\">\n                      <h4 className=\"font-bold text-gray-800\">\n                        {course.title}\n                      </h4>\n                      <p className=\"text-sm text-gray-500 mt-1 line-clamp-2\">\n                        {course.description}\n                      </p>\n\n                      {course.isEnrolled ? (\n                        <>\n                          {\" \"}\n                          <p className=\"text-xs text-gray-500 mt-2\">\n                            Progreso: {course.progress.length} /{\" \"}\n                            {course.lessons?.length || 0}\n                          </p>\n                          <button\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              router.push(`/courses/${course.id}`);\n                            }}\n                            className=\"mt-3 w-full text-center text-sm bg-atenea cursor-pointer py-2 hover:bg-blue-700 text-white rounded\"\n                          >\n                            Entrar al Curso\n                          </button>\n                        </>\n                      ) : (\n                        <>\n                          <p className=\"text-xs text-gray-500 mt-2\">\n                            Progreso: {course.progress.length} /{\" \"}\n                            {course.lessons?.length || 0}\n                          </p>\n                          <button\n                            className=\"mt-3 w-full text-center text-sm bg-gray-400 text-white py-2 rounded cursor-not-allowed\"\n                            disabled\n                          >\n                            Curso Bloqueado\n                          </button>\n                        </>\n                      )}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <p className=\"text-gray-500\">No hay cursos disponibles.</p>\n            )}\n          </section>\n        )}\n\n        {/* Panel Profesores */}\n        {userData?.role === \"teacher\" && (\n          <section className=\"bg-white p-6 rounded-lg shadow mb-8\">\n            <div className=\"flex justify-between items-center mb-4\">\n              <h3 className=\"text-xl font-medium text-gray-800\">Tus Cursos</h3>\n              <button\n                onClick={() => router.push(\"/teacher/create-course\")}\n                className=\"bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-4 py-2 rounded\"\n              >\n                + Nuevo Curso\n              </button>\n            </div>\n\n            {createdCourses.length > 0 ? (\n              <div className=\"grid gap-5 md:grid-cols-2 lg:grid-cols-3\">\n                {createdCourses.map((course) => (\n                  <div\n                    key={course.id}\n                    className=\"border rounded-lg p-4 hover:shadow-md transition bg-purple-50\"\n                  >\n                    <div className=\"flex justify-between\">\n                      <h4\n                        className=\"font-bold text-gray-800 cursor-pointer hover:text-indigo-600\"\n                        onClick={() =>\n                          router.push(`/teacher/course/${course.id}`)\n                        }\n                      >\n                        {course.title}\n                      </h4>\n                      <button\n                        className=\"cursor-pointer hover:text-indigo-600\"\n                        onClick={() =>\n                          router.push(`/teacher/course/${course.id}`)\n                        }\n                      >\n                        ‚úèÔ∏è Editar\n                      </button>\n                    </div>\n                    <p className=\"text-sm text-gray-500 mt-1\">\n                      {course.lessons?.length || 0} lecciones\n                    </p>\n                    <p className=\"text-sm text-atenea cursor-pointer py-2 font-medium mt-1\">\n                      {course.studentCount}{\" \"}\n                      {course.studentCount === 1 ? \"estudiante\" : \"estudiantes\"}\n                    </p>\n                    <div className=\"flex items-center gap-1 mt-1\">\n                      <span className=\"text-yellow-500 text-sm\">\n                        {\"‚≠ê\".repeat(Math.floor(course.averageRating))}\n                        {\"‚òÜ\".repeat(5 - Math.floor(course.averageRating))}\n                      </span>\n                      <span className=\"text-sm text-gray-600 ml-1\">\n                        {course.averageRating !== \"Sin\"\n                          ? course.averageRating\n                          : \"Sin\"}{\" \"}\n                        ({course.reviewCount})\n                      </span>\n                    </div>\n\n                    <button\n                      onClick={() => openReviewsModal(course)}\n                      className=\"text-xs mt-2 text-indigo-600 hover:underline block\"\n                    >\n                      Ver rese√±as ({course.reviewCount})\n                    </button>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <p className=\"text-gray-500\">No has creado ning√∫n curso.</p>\n            )}\n          </section>\n        )}\n      </main>\n\n      {/* ‚úÖ Modal de Rese√±as */}\n      {selectedCourseReviews && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n          <div className=\"bg-white rounded-lg shadow-lg max-w-lg w-full max-h-[90vh] flex flex-col\">\n            <div className=\"p-5 border-b flex justify-between items-center\">\n              <h3 className=\"text-xl font-semibold text-gray-800\">\n                Rese√±as - {selectedCourseReviews.title}\n              </h3>\n              <button\n                onClick={closeReviewsModal}\n                className=\"text-gray-500 hover:text-gray-700 text-2xl\"\n              >\n                &times;\n              </button>\n            </div>\n\n            <div className=\"p-5 overflow-y-auto flex-1\">\n              {selectedCourseReviews.reviews.length > 0 ? (\n                <ul className=\"space-y-4\">\n                  {selectedCourseReviews.reviews.map((review, idx) => (\n                    <li key={idx} className=\"border-b pb-3 last:border-b-0\">\n                      <div className=\"flex justify-between\">\n                        <strong className=\"text-gray-800\">\n                          {review.userName}\n                        </strong>\n                        <span className=\"text-yellow-500\">\n                          {\"‚≠ê\".repeat(review.rating)}\n                          {\"‚òÜ\".repeat(5 - review.rating)}\n                        </span>\n                      </div>\n                      <p className=\"text-sm text-gray-600 mt-1\">\n                        {review.timestamp}\n                      </p>\n                      {review.comment && (\n                        <p className=\"text-gray-700 mt-2 italic\">\n                          \"{review.comment}\"\n                        </p>\n                      )}\n                    </li>\n                  ))}\n                </ul>\n              ) : (\n                <p className=\"text-gray-500 text-center py-4\">\n                  No hay rese√±as a√∫n.\n                </p>\n              )}\n            </div>\n\n            <div className=\"p-5 border-t text-right\">\n              <button\n                onClick={closeReviewsModal}\n                className=\"px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded text-gray-800\"\n              >\n                Cerrar\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n"
        }
    ]
}